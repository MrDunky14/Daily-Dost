const dragDropModule={isDragging:!1,dragSource:null,init(){this.makeCardsDraggable(),this.setupCustomizeMode()},makeCardsDraggable(){document.querySelectorAll("[data-card-id]").forEach((e,t)=>{if(e.dataset.index=t,e.classList.add("draggable-card"),!e.querySelector(".drag-handle")){const t=document.createElement("div");t.className="drag-handle",t.innerHTML="⋮⋮",e.style.position="relative",e.appendChild(t)}e.addEventListener("dragstart",t=>this.handleDragStart(t,e)),e.addEventListener("dragend",t=>this.handleDragEnd(t,e)),e.addEventListener("dragover",t=>this.handleDragOver(t,e)),e.addEventListener("drop",t=>this.handleDrop(t,e)),e.addEventListener("dragenter",t=>this.handleDragEnter(t,e)),e.addEventListener("dragleave",t=>this.handleDragLeave(t,e)),e.addEventListener("touchstart",t=>this.handleTouchStart(t,e),{passive:!1}),e.addEventListener("touchmove",t=>this.handleTouchMove(t,e),{passive:!1}),e.addEventListener("touchend",t=>this.handleTouchEnd(t,e))})},handleTouchStart(e,t){if(!t.classList.contains("customizing"))return;const a=e.touches[0];this.touchStartY=a.clientY,this.touchStartX=a.clientX,this.isDragging=!0,this.dragSource=t,t.classList.add("dragging")},handleTouchMove(e,t){if(!this.isDragging||!t.classList.contains("customizing"))return;e.preventDefault();const a=e.touches[0],s=document.elementFromPoint(a.clientX,a.clientY),r=s?.closest("[data-card-id]");document.querySelectorAll("[data-card-id]").forEach(e=>e.classList.remove("drag-over")),r&&r!==this.dragSource&&r.classList.contains("customizing")&&r.classList.add("drag-over")},handleTouchEnd(e,t){if(!this.isDragging)return;const a=document.querySelector("[data-card-id].drag-over");if(a&&this.dragSource&&this.dragSource!==a){const e=a.parentElement,t=Array.from(e.querySelectorAll("[data-card-id]"));t.indexOf(this.dragSource)<t.indexOf(a)?a.after(this.dragSource):a.before(this.dragSource),this.updateIndices(),this.saveCardLayout(),"function"==typeof showToast&&showToast("Card position saved!","success")}this.isDragging=!1,this.dragSource?.classList.remove("dragging"),document.querySelectorAll("[data-card-id]").forEach(e=>e.classList.remove("drag-over")),this.dragSource=null},handleDragStart(e,t){t.classList.contains("customizing")&&(this.isDragging=!0,this.dragSource=t,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.dataset.cardId),t.classList.add("dragging"),requestAnimationFrame(()=>{t.style.opacity="0.5"}))},handleDragEnd(e,t){this.isDragging=!1,t.classList.remove("dragging"),t.style.opacity="1",document.querySelectorAll("[data-card-id]").forEach(e=>e.classList.remove("drag-over"))},handleDragOver(e,t){t.classList.contains("customizing")&&(e.preventDefault(),e.dataTransfer.dropEffect="move")},handleDragEnter(e,t){t.classList.contains("customizing")&&t!==this.dragSource&&t.classList.add("drag-over")},handleDragLeave(e,t){t.contains(e.relatedTarget)||t.classList.remove("drag-over")},handleDrop(e,t){if(t.classList.contains("customizing")){if(e.preventDefault(),e.stopPropagation(),this.dragSource&&this.dragSource!==t){const e=t.parentElement,a=Array.from(e.querySelectorAll("[data-card-id]"));a.indexOf(this.dragSource)<a.indexOf(t)?t.after(this.dragSource):t.before(this.dragSource),this.updateIndices(),this.saveCardLayout(),"function"==typeof showToast&&showToast("Card position saved!","success")}t.classList.remove("drag-over")}},updateIndices(){document.querySelectorAll("[data-card-id]").forEach((e,t)=>{e.dataset.index=t})},setupCustomizeMode(){const e=document.getElementById("customize-layout-btn");e&&e.addEventListener("click",()=>this.toggleCustomizeMode())},toggleCustomizeMode(){const e=document.querySelectorAll("[data-card-id]"),t=e[0]?.classList.contains("customizing");e.forEach(e=>{t?(e.classList.remove("customizing"),e.draggable=!1):(e.classList.add("customizing"),e.draggable=!0)}),this.showCustomizeBanner(!t);const a=document.getElementById("customize-layout-btn");if(a){const e=a.querySelector(".material-symbols-outlined, .material-icons"),s=a.querySelector("span:not(.material-symbols-outlined):not(.material-icons)");t?(e&&(e.textContent="dashboard_customize"),s&&(s.textContent="Customize")):(e&&(e.textContent="check"),s&&(s.textContent="Done"))}},showCustomizeBanner(e){let t=document.getElementById("customize-banner");e&&!t?(t=document.createElement("div"),t.id="customize-banner",t.className="fixed left-1/2 -translate-x-1/2 z-40 bg-primary/95 text-white py-2 px-4 md:py-3 md:px-6 flex items-center gap-2 md:gap-4 rounded-full shadow-lg backdrop-blur-sm border border-primary/50",t.style.cssText="bottom: 100px; max-width: calc(100% - 32px);",t.innerHTML='\n        <span class="material-symbols-outlined animate-pulse text-sm md:text-base">info</span>\n        <span class="text-xs md:text-sm font-medium whitespace-nowrap">Drag to rearrange</span>\n        <button id="customize-done" class="px-3 py-1 md:px-4 md:py-1.5 bg-white/20 rounded-full hover:bg-white/30 transition-all text-xs md:text-sm font-bold">Done</button>\n      ',document.body.appendChild(t),t.style.opacity="0",t.style.transform="translate(-50%, -20px)",requestAnimationFrame(()=>{t.style.transition="all 0.3s ease-out",t.style.opacity="1",t.style.transform="translate(-50%, 0)"}),document.getElementById("customize-done")?.addEventListener("click",()=>this.toggleCustomizeMode())):!e&&t&&(t.style.opacity="0",t.style.transform="translate(-50%, -20px)",setTimeout(()=>t.remove(),300))},saveCardLayout(){const e=document.querySelectorAll("[data-card-id]"),t=Array.from(e).map(e=>e.dataset.cardId);localStorage.setItem("studios_cardLayout",JSON.stringify(t)),"function"==typeof window.syncToFirebase&&window.syncToFirebase("cardLayout",t)},loadCardLayout(){const e=localStorage.getItem("studios_cardLayout");if(e)try{const t=JSON.parse(e),a=document.querySelector(".desktop-grid");a&&(t.forEach(e=>{const t=document.querySelector(`[data-card-id="${e}"]`);t&&a.appendChild(t)}),this.updateIndices())}catch(e){console.warn("Failed to load card layout:",e)}}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>dragDropModule.init()):dragDropModule.init(),window.dragDropModule=dragDropModule;