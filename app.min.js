import{app,auth,db,signInAnonymously,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,linkWithPopup,signInWithCredential,updateProfile,doc,setDoc,addDoc,updateDoc,deleteDoc,onSnapshot,collection,query,writeBatch,getDocs,where,getDoc}from"./services/firebase.min.js";const appId="daily-dost";let userId,isLocalMode=!1,habits=[],habitLogs={},achievements=[],assignments=[],grades=[],sleepLogs={},stickyNotes=[],expenses=[],exams=[],userProfile={level:1,xp:0,dailyLimit:200},currentView="dashboard-view",pomodoro={timerId:null,mode:"work",timeLeft:1500,isRunning:!1,completedCycles:0},correlationChartInstance,trendsChartInstance,wakeLock=null,audioCtx=null,currentSource=null,gainNode=null,shouldAutoLogin=!0;const localStore={get:e=>{try{return JSON.parse(localStorage.getItem(`studios_${e}`))||{}}catch{return{}}},set:(e,t)=>localStorage.setItem(`studios_${e}`,JSON.stringify(t)),getArray:e=>{try{return JSON.parse(localStorage.getItem(`studios_${e}`))||[]}catch{return[]}},setArray:(e,t)=>localStorage.setItem(`studios_${e}`,JSON.stringify(t)),remove:e=>localStorage.removeItem(`studios_${e}`)},loadingOverlay=document.getElementById("loading-overlay"),modalContainer=document.getElementById("modal-container"),XP_PER_LEVEL=100,XP_PER_DIFFICULTY={easy:10,medium:20,hard:30},POMODORO_TIMES={work:1500,shortBreak:300,longBreak:900},HABIT_CATEGORIES={study:{name:"Study",color:"#3b82f6"},reading:{name:"Reading",color:"#8b5cf6"},lab:{name:"Lab Work",color:"#10b981"},health:{name:"Health",color:"#ef4444"},mindfulness:{name:"Mindfulness",color:"#f59e0b"},other:{name:"Other",color:"#64748b"}},ACHIEVEMENTS_LIST={first_habit:{name:"Getting Started",description:"Complete your first habit.",icon:"üéØ"},"7_day_streak":{name:"Week Warrior",description:"7-day streak on a habit.",icon:"üìÖ"},first_pomodoro:{name:"Focused",description:"Complete a Pomodoro session.",icon:"üçÖ"},perfect_day:{name:"Perfect Day",description:"Complete all daily habits.",icon:"‚úÖ"},night_owl:{name:"Night Owl",description:"Complete a habit after 10 PM.",icon:"ü¶â"},early_bird:{name:"Early Bird",description:"Complete a habit before 7 AM.",icon:"üåÖ"},weekend_warrior:{name:"Weekend Warrior",description:"Complete a habit on a weekend.",icon:"üéâ"},math_whiz:{name:"Math Whiz",description:"Use the calculator.",icon:"üßÆ"},grade_guru:{name:"Grade Guru",description:"Log your first grade.",icon:"üìù"},bunk_master:{name:"Strategist",description:"Use the Bunk-o-Meter.",icon:"üìâ"}},getTodayString=()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},getDateString=e=>`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,debounce=(e,t)=>{let a;return function(...o){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...o)},t)}},setFixedChartSize=(e,t)=>{if(!e)return;const a=e.parentElement;a&&(a.style.position="relative"),t&&(e.style.height=`${t}px`)},SAMPLE_GRADES=[{date:"2025-09-01",grade:75},{date:"2025-09-14",grade:85},{date:"2025-09-28",grade:92}],SAMPLE_MOODS={"2025-09-01":"neutral","2025-09-14":"happy","2025-09-28":"sad"},SAMPLE_SLEEP={"2025-09-01":7,"2025-09-14":8,"2025-09-28":6},normalizeStatus=e=>"complete"===e?"completed":"skip"===e?"skipped":"fail"===e?"failed":e,isCompleted=e=>"completed"===normalizeStatus(e),isSkipped=e=>"skipped"===normalizeStatus(e),isFailed=e=>"failed"===normalizeStatus(e),showToast=(e,t="info")=>{let a=document.getElementById("toast-container");a||(a=document.createElement("div"),a.id="toast-container",a.className="fixed bottom-5 right-5 z-50 flex flex-col gap-3 pointer-events-none",document.body.appendChild(a));const o={success:{icon:"check_circle",color:"text-green-400",border:"border-green-500/30",bg:"bg-green-500/10"},error:{icon:"error",color:"text-red-400",border:"border-red-500/30",bg:"bg-red-500/10"},warning:{icon:"warning",color:"text-yellow-400",border:"border-yellow-500/30",bg:"bg-yellow-500/10"},info:{icon:"info",color:"text-blue-400",border:"border-blue-500/30",bg:"bg-blue-500/10"}};if("info"===t){const a=e.toLowerCase();a.includes("success")||a.includes("complete")||a.includes("level up")||a.includes("unlocked")?t="success":a.includes("fail")||a.includes("error")||a.includes("wrong")?t="error":(a.includes("warn")||a.includes("broken"))&&(t="warning")}const n=o[t]||o.info,s=document.createElement("div");s.className=`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl backdrop-blur-md border shadow-lg min-w-[300px] max-w-sm transform translate-y-10 opacity-0 ${n.bg} ${n.border} border`,s.innerHTML=`\n    <span class="material-symbols-outlined ${n.color} text-xl">${n.icon}</span>\n    <p class="text-sm font-medium text-white/90 flex-1">${e}</p>\n    <button class="text-white/50 hover:text-white transition-colors">\n      <span class="material-symbols-outlined text-lg">close</span>\n    </button>\n  `,a.appendChild(s),"undefined"!=typeof anime?anime({targets:s,translateY:[20,0],opacity:[0,1],duration:400,easing:"easeOutElastic(1, .8)"}):(s.style.transform="translateY(0)",s.style.opacity="1");const r=()=>{"undefined"!=typeof anime?anime({targets:s,translateX:[0,50],opacity:[1,0],duration:300,easing:"easeInCubic",complete:()=>s.remove()}):s.remove()};s.querySelector("button").onclick=r,setTimeout(r,4e3)},switchViewWithAnimation=e=>{document.querySelectorAll(".view").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(e);if(!t)return void console.error(`View not found: ${e}`);t.classList.remove("hidden");const a=["bg-primary/20","text-primary","shadow-[0_0_15px_rgba(139,92,246,0.3)]","border-primary/30"],o=["text-text-muted","hover:text-white","hover:bg-white/5","border-transparent"];document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.remove(...a),e.classList.add(...o)});const n=document.getElementById(`tab-${e.split("-")[0]}`);n&&(n.classList.remove(...o),n.classList.add(...a)),currentView=e,"analytics-view"===e&&renderAnalytics(),"rewards-view"===e&&renderRewards(),setTimeout(()=>{const e=t.querySelectorAll(".card");e.length>0&&"undefined"!=typeof anime&&anime({targets:e,opacity:[0,1],translateY:[30,0],delay:anime.stagger(80),duration:600,easing:"easeOutCubic"})},50)},switchView=switchViewWithAnimation;window.switchView=switchView,window.getStudiosData=()=>({sleepLogs:sleepLogs,moodData:userProfile.moods||{}}),window.updateSyncStatus=()=>{const e=document.getElementById("sync-status-text");if(e)return isLocalMode?(e.innerText="Local Mode ‚Ä¢ Data saved on device",void(e.className="text-xs text-emerald-400 font-medium flex items-center gap-1")):auth.currentUser?auth.currentUser.isAnonymous?(e.innerText="Guest Mode ‚Ä¢ Data on this device only",void(e.className="text-xs text-orange-400 font-medium flex items-center gap-1")):void(navigator.onLine?(e.innerHTML='<span class="material-symbols-outlined text-[10px] animate-pulse">cloud_done</span> Cloud Sync Active',e.className="text-xs text-blue-400 font-medium flex items-center gap-1"):(e.innerHTML='<span class="material-symbols-outlined text-[10px]">cloud_off</span> Offline ‚Ä¢ Changes queued',e.className="text-xs text-gray-400 font-medium flex items-center gap-1")):(e.innerText="Offline ‚Ä¢ Sign in to sync",void(e.className="text-xs text-gray-400 font-medium flex items-center gap-1"))},window.addEventListener("online",window.updateSyncStatus),window.addEventListener("offline",window.updateSyncStatus);const setupLoginListeners=()=>{const e=document.getElementById("google-login-btn"),t=document.getElementById("guest-login-btn");e&&(e.onclick=async()=>{try{const e=new GoogleAuthProvider;await signInWithPopup(auth,e)}catch(e){console.error("Google Sign-In Error:",e),showToast("Google Sign-In failed: "+e.message,"error")}}),t&&(t.onclick=async()=>{try{await signInAnonymously(auth)}catch(e){console.error("Guest Sign-In Error:",e),showToast("Guest Sign-In failed.","error")}})},showWelcomeGuide=()=>{modalContainer.innerHTML='\n    <div class="modal-content w-full max-w-2xl mx-auto p-0 overflow-hidden animate-fade-in-up">\n      <div class="bg-primary p-6 text-white text-center">\n        <h2 class="text-2xl font-bold mb-2">Welcome to StudiOS! üöÄ</h2>\n        <p class="opacity-90">Your ultimate student companion.</p>\n      </div>\n      \n      <div class="p-6 space-y-6 max-h-[60vh] overflow-y-auto custom-scrollbar">\n        <div class="flex gap-4 items-start">\n            <div class="w-12 h-12 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-2xl shrink-0">üìä</div>\n            <div>\n                <h3 class="font-bold text-lg">Track Everything</h3>\n                <p class="text-sm text-gray-500 dark:text-gray-400">Log habits, assignments, grades, and expenses in one place.</p>\n            </div>\n        </div>\n        \n        <div class="flex gap-4 items-start">\n            <div class="w-12 h-12 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-2xl shrink-0">üçÖ</div>\n            <div>\n                <h3 class="font-bold text-lg">Focus Garden</h3>\n                <p class="text-sm text-gray-500 dark:text-gray-400">Use the Pomodoro timer to grow your virtual garden while you study.</p>\n            </div>\n        </div>\n\n        <div class="flex gap-4 items-start">\n            <div class="w-12 h-12 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-2xl shrink-0">üìà</div>\n            <div>\n                <h3 class="font-bold text-lg">Smart Analytics</h3>\n                <p class="text-sm text-gray-500 dark:text-gray-400">Visualize your sleep, mood, and academic performance trends.</p>\n            </div>\n        </div>\n\n        <div class="flex gap-4 items-start">\n            <div class="w-12 h-12 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center text-2xl shrink-0">üèÜ</div>\n            <div>\n                <h3 class="font-bold text-lg">Gamified Growth</h3>\n                <p class="text-sm text-gray-500 dark:text-gray-400">Earn XP, level up, and unlock achievements as you stay consistent.</p>\n            </div>\n        </div>\n      </div>\n      \n      <div class="p-4 border-t border-gray-100 dark:border-slate-700 flex justify-end">\n        <button id="close-welcome-btn" class="px-6 py-3 bg-primary text-white rounded-xl font-bold shadow-lg shadow-primary/30 hover:scale-105 transition-transform w-full sm:w-auto">\n            Let\'s Get Started!\n        </button>\n      </div>\n    </div>',modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),document.getElementById("close-welcome-btn").addEventListener("click",()=>{modalContainer.classList.add("hidden"),modalContainer.classList.remove("flex")})},migrateUserData=async e=>{if(!e.isAnonymous)try{const t=doc(db,"users",e.uid),a=await getDoc(t);if(a.exists()&&"complete"===a.data().migrationStatus)return;console.log("Starting migration..."),showToast("Optimizing database... please wait.","info");const o=`artifacts/${appId}/users/${e.uid}`;let n=writeBatch(db),s=0;const r=async()=>{s>=400&&(await n.commit(),n=writeBatch(db),s=0)},d=doc(db,`${o}/profile/userProfile`),i=await getDoc(d);i.exists()?(n.set(t,{...i.data(),migrationStatus:"complete"},{merge:!0}),s++):(n.set(t,{migrationStatus:"complete"},{merge:!0}),s++),await r();const l=async(e,t,a=null)=>{const d=collection(db,`${o}/${e}`),i=await getDocs(d);for(const e of i.docs){const o={...e.data()};a&&(o.type=a);const d=doc(db,t,e.id);n.set(d,o),s++,await r()}};await l("habits",`users/${e.uid}/habits`),await l("habitLogs",`users/${e.uid}/logs`),await l("expenses",`users/${e.uid}/finance`),await l("achievements",`users/${e.uid}/achievements`),await l("sleepLogs",`users/${e.uid}/sleepLogs`),await l("stickyNotes",`users/${e.uid}/stickyNotes`),await l("assignments",`users/${e.uid}/academics`,"assignment"),await l("grades",`users/${e.uid}/academics`,"grade"),s>0&&await n.commit(),showToast("Database optimization complete!","success")}catch(e){console.warn("Migration skipped or failed:",e.message)}},initLocalMode=()=>{console.log("Entering local-only mode..."),habits=localStore.getArray("habits"),habitLogs=localStore.get("habitLogs"),achievements=localStore.getArray("achievements"),assignments=localStore.getArray("assignments"),grades=localStore.getArray("grades"),sleepLogs=localStore.get("sleepLogs"),stickyNotes=localStore.getArray("stickyNotes"),expenses=localStore.getArray("expenses"),userProfile=localStore.get("profile")||{level:1,xp:0,targetGpa:3.5,dailyLimit:200};const e=document.getElementById("user-avatar");e&&(e.src="https://ui-avatars.com/api/?name=Local&background=10b981&color=fff&size=128");const t=document.getElementById("sync-status-text");window.updateSyncStatus?window.updateSyncStatus():t&&(t.innerText="Local Mode ‚Ä¢ Data saved on device");const a=document.getElementById("cloud-sync-btn");a&&a.classList.add("hidden");!localStorage.getItem("hasVisited")&&(localStorage.setItem("hasVisited","true"),showWelcomeGuide()),setupListeners(),loadingOverlay.classList.add("hidden"),showToast("Working in local mode","info")},hasLocalData=()=>localStore.getArray("habits").length>0||localStore.getArray("assignments").length>0||localStore.getArray("expenses").length>0||localStore.getArray("stickyNotes").length>0||localStore.getArray("grades").length>0||Object.keys(localStore.get("habitLogs")).length>0,syncLocalDataToCloud=async e=>{showToast("Syncing local data to cloud...","info");try{let t=writeBatch(db),a=0;const o=async()=>{a>=400&&(await t.commit(),t=writeBatch(db),a=0)},n=localStore.getArray("habits");for(const s of n){const n=doc(collection(db,`users/${e.uid}/habits`)),{id:r,...d}=s;t.set(n,d),a++,await o()}const s=localStore.get("habitLogs");for(const n in s)for(const r in s[n]){const d=s[n][r],i=doc(collection(db,`users/${e.uid}/logs`)),{id:l,...c}=d;t.set(i,{...c,date:n,userId:e.uid}),a++,await o()}const r=localStore.getArray("assignments");for(const n of r){const s=doc(collection(db,`users/${e.uid}/academics`)),{id:r,...d}=n;t.set(s,d),a++,await o()}const d=localStore.getArray("grades");for(const n of d){const s=doc(collection(db,`users/${e.uid}/academics`)),{id:r,...d}=n;t.set(s,d),a++,await o()}const i=localStore.getArray("expenses");for(const n of i){const s=doc(collection(db,`users/${e.uid}/finance`)),{id:r,...d}=n;t.set(s,d),a++,await o()}const l=localStore.getArray("stickyNotes");for(const n of l){const s=doc(collection(db,`users/${e.uid}/stickyNotes`)),{id:r,...d}=n;t.set(s,d),a++,await o()}const c=localStore.get("sleepLogs");for(const n in c){const s=doc(db,`users/${e.uid}/sleepLogs`,n);t.set(s,{hours:c[n]}),a++,await o()}const u=localStore.get("profile");if(Object.keys(u).length>0){const o=doc(db,`users/${e.uid}`);t.set(o,u,{merge:!0}),a++}const m=localStore.getArray("achievements");for(const n of m){const s=doc(collection(db,`users/${e.uid}/achievements`)),{id:r,...d}=n;t.set(s,d),a++,await o()}a>0&&await t.commit(),localStore.remove("habits"),localStore.remove("habitLogs"),localStore.remove("assignments"),localStore.remove("grades"),localStore.remove("expenses"),localStore.remove("stickyNotes"),localStore.remove("sleepLogs"),localStore.remove("profile"),localStore.remove("achievements"),showToast("Local data synced to cloud! ‚òÅÔ∏è","success")}catch(e){console.error("Sync failed:",e),showToast("Sync failed. Your local data is preserved.","error")}},initializeFirebase=async()=>{try{setupLoginListeners();const e=document.getElementById("close-login-modal-btn"),t=document.getElementById("login-modal");e?.addEventListener("click",()=>{t?.classList.add("hidden"),isLocalMode=!0,userId="local_user",initLocalMode()}),onAuthStateChanged(auth,async e=>{const t=document.getElementById("login-modal");if(e){t&&t.classList.add("hidden"),userId=e.uid,console.log(`Authenticated: ${userId}, anonymous: ${e.isAnonymous}`),await migrateUserData(e);document.getElementById("sync-status-text");if(e.isAnonymous){document.getElementById("user-avatar").src="https://ui-avatars.com/api/?name=Guest&background=667eea&color=fff&size=128";const e=document.getElementById("cloud-sync-btn");e&&(e.classList.remove("hidden"),e.onclick=()=>showLoginModal(!1)),window.updateSyncStatus&&window.updateSyncStatus();!localStorage.getItem("hasVisited")&&(localStorage.setItem("hasVisited","true"),showWelcomeGuide())}else{if(hasLocalData()){await showConfirmModal("You have local data saved on this device. Would you like to sync it to the cloud?")?await syncLocalDataToCloud(e):(localStore.remove("habits"),localStore.remove("habitLogs"),localStore.remove("assignments"),localStore.remove("grades"),localStore.remove("expenses"),localStore.remove("stickyNotes"),localStore.remove("sleepLogs"),localStore.remove("profile"),localStore.remove("achievements"))}isLocalMode=!1;const{isNew:t}=await updateUserProfile(e);t&&(showAvatarPickerModal(),showWelcomeGuide()),window.updateSyncStatus&&window.updateSyncStatus(),document.getElementById("cloud-sync-btn")?.classList.add("hidden")}setupListeners(),loadingOverlay.classList.add("hidden")}else t&&t.classList.remove("hidden"),loadingOverlay.classList.add("hidden")})}catch(e){console.error("Firebase Init Error:",e),showToast("Failed to initialize. Please refresh."),loadingOverlay.classList.add("hidden")}};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("user-avatar");e&&e.addEventListener("click",handleProfileClick),document.addEventListener("click",e=>{(e.target.classList.contains("modal-overlay")||"modal-container"===e.target.id)&&("modal-container"===e.target.id?closeModal():e.target.remove())})});const handleSignOut=async()=>{try{shouldAutoLogin=!1,userId=null,habits=[],habitLogs={},userProfile={level:1,xp:0,targetGpa:3.5,dailyLimit:200},await auth.signOut(),console.log("Signed out successfully"),showToast("Signed out"),showLoginModal(!0)}catch(e){console.error("Sign-out error:",e),showToast("Failed to sign out"),shouldAutoLogin=!0}};function handleProfileClick(){auth.currentUser?auth.currentUser.isAnonymous&&showLoginModal(!1):showToast("App loading...")}const migrateAnonymousData=async e=>{console.log("Data migration check complete for:",e)},handleGoogleSignIn=async()=>{try{const e=new GoogleAuthProvider;if(e.addScope("profile"),e.addScope("email"),!auth.currentUser){const t=(await signInWithPopup(auth,e)).user;return await updateUserProfile(t),document.getElementById("signin-modal")?.remove(),showToast("Welcome back!"),void(shouldAutoLogin=!0)}const t=(await linkWithPopup(auth.currentUser,e)).user;console.log("Account linked successfully"),await migrateAnonymousData(t.uid);if(await updateUserProfile(t)){const e=document.getElementById("signin-modal");e?.remove(),setupListeners(),showToast("Google account connected!")}}catch(e){if("auth/credential-already-in-use"===e.code)try{const t=GoogleAuthProvider.credentialFromError(e);t?await signInWithCredential(auth,t):await signInWithPopup(auth,new GoogleAuthProvider),document.getElementById("signin-modal")?.remove(),showToast("Welcome back!"),shouldAutoLogin=!0}catch(e){console.error("Re-sign in failed:",e),showToast("Login failed. Please try again.")}else handleLinkingError(e)}},handleLinkingError=e=>{console.error("Linking error:",e.code,e.message),"auth/credential-already-in-use"===e.code?showToast("This Google account is already linked to another account"):"auth/invalid-credential"===e.code?showToast("Sign-in was cancelled"):"auth/operation-not-supported-in-this-environment"===e.code?handleGoogleSignInWithRedirect():showToast(`Error: ${e.message}`)};function createSignInModal(e=!1){const t=document.createElement("div");t.className="modal-content p-6 max-w-sm w-full mx-4 text-center",t.id="signin-modal";const a=e?"":'<button id="modal-close" class="btn-close">&times;</button>',o=e?'<button id="guest-signin-btn" class="mt-4 text-sm text-gray-500 hover:text-gray-700 underline">Continue as Guest</button>':"",n=e?"Welcome to Daily Dost":"Sign In with Google",s=e?"Sign in to save your progress or continue as a guest.":"Sync data across devices and never lose progress!";return t.innerHTML=`\n      ${a}\n      <h2 class="text-xl font-bold mb-2">${n}</h2>\n      <p class="text-sm text-gray-500 mb-6">${s}</p>\n      <button id="google-signin-btn" class="btn-animate w-full py-3 rounded-lg bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 font-semibold shadow-sm hover:bg-gray-50 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-3">\n        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>\n        Sign In with Google\n      </button>\n      ${o}\n  `,t}function showLoginModal(e=!1){document.getElementById("signin-modal")?.remove();const t=createSignInModal(e);modalContainer.appendChild(t);const a=t.querySelector("#google-signin-btn");if(a?.addEventListener("click",handleGoogleSignIn),e){const e=t.querySelector("#guest-signin-btn");e?.addEventListener("click",async()=>{loadingOverlay.classList.remove("hidden"),t.remove(),shouldAutoLogin=!0;try{await signInAnonymously(auth)}catch(e){console.error(e),loadingOverlay.classList.add("hidden"),showToast("Guest login failed"),showLoginModal(!0)}})}else{const e=t.querySelector("#modal-close");e?.addEventListener("click",()=>{t.remove()})}}const createUserDocument=async e=>{try{const t=doc(db,"users",e.uid);(await getDoc(t)).exists()?await updateDoc(t,{lastSignIn:(new Date).toISOString(),displayName:e.displayName,photoURL:e.photoURL}):await setDoc(t,{uid:e.uid,email:e.email,displayName:e.displayName||"User",photoURL:e.photoURL||null,isAnonymous:e.isAnonymous,createdAt:(new Date).toISOString(),lastSignIn:(new Date).toISOString(),settings:{theme:"dark",notifications:!0}})}catch(e){console.error("Firestore user doc error:",e)}},checkWeeklyAchievementReset=async()=>{if(!userProfile||!achievements)return;const e=new Date,t=userProfile.lastAchievementResetDate,a=new Date(e),o=a.getDay(),n=a.getDate()-o+(0===o?-6:1);a.setDate(n),a.setHours(0,0,0,0);if((t?new Date(t):new Date(0))<a){console.log("New week detected. Resetting achievements...");const e=["first_habit","first_pomodoro","math_whiz","grade_guru","bunk_master","7_day_streak"],t=achievements.filter(t=>!e.includes(t.achievementId)),o=writeBatch(db);t.length>0&&t.forEach(e=>{o.delete(doc(db,`users/${userId}/achievements`,e.id))});const n=doc(db,`users/${userId}`);o.set(n,{lastAchievementResetDate:a.toISOString()},{merge:!0}),await o.commit(),t.length>0&&showToast("New Week! Achievements have been reset. üöÄ")}},setupListeners=()=>{if(isLocalMode)return renderDashboard(),renderAssignments(),renderSleepTracker(),renderStickyNotes(),renderFinance(),void loadingOverlay.classList.add("hidden");const e={profile:`users/${userId}`,habits:`users/${userId}/habits`,logs:`users/${userId}/logs`,achievements:`users/${userId}/achievements`,academics:`users/${userId}/academics`,sleepLogs:`users/${userId}/sleepLogs`,stickyNotes:`users/${userId}/stickyNotes`,finance:`users/${userId}/finance`};onSnapshot(doc(db,e.profile),e=>{if(e.exists()){if(userProfile={...userProfile,...e.data()},checkWeeklyAchievementReset(),userProfile.settings?.theme){const e=userProfile.settings.theme;document.documentElement.setAttribute("data-theme",e);const t="dark"===e,a=document.getElementById("theme-icon-sun"),o=document.getElementById("theme-icon-moon"),n=document.getElementById("theme-text");a&&o&&(a.classList.toggle("hidden",t),o.classList.toggle("hidden",!t)),n&&(n.textContent="dark"===e?"NIGHT":"DAY")}}else setDoc(e.ref,userProfile);renderDashboard(),"analytics-view"===currentView&&renderAnalytics()}),onSnapshot(query(collection(db,e.habits)),e=>{habits=e.docs.map(e=>({id:e.id,...e.data()})),renderDashboard()}),onSnapshot(query(collection(db,e.logs)),e=>{habitLogs={},e.docs.forEach(e=>{const t={id:e.id,...e.data()};habitLogs[t.date]||(habitLogs[t.date]={}),habitLogs[t.date][t.habitId]=t}),renderDashboard()}),onSnapshot(query(collection(db,e.achievements)),e=>{achievements=e.docs.map(e=>({id:e.id,...e.data()})),checkWeeklyAchievementReset()}),onSnapshot(query(collection(db,e.academics)),e=>{const t=e.docs.map(e=>({id:e.id,...e.data()}));assignments=t.filter(e=>"assignment"===e.type),grades=t.filter(e=>"grade"===e.type),renderAssignments(),"analytics-view"===currentView&&renderAnalytics()}),onSnapshot(query(collection(db,e.sleepLogs)),e=>{sleepLogs={},e.docs.forEach(e=>sleepLogs[e.id]=e.data().hours),renderSleepTracker(),"analytics-view"===currentView&&renderAnalytics()}),onSnapshot(query(collection(db,e.stickyNotes)),e=>{stickyNotes=e.docs.map(e=>({id:e.id,...e.data()})),renderStickyNotes()}),onSnapshot(query(collection(db,e.finance)),e=>{expenses=e.docs.map(e=>({id:e.id,...e.data()})),renderFinance()}),loadingOverlay.classList.add("hidden")},renderDashboard=()=>{userId&&(renderUserProfile(),renderHabitsForToday(),renderDailyProgress(),renderMentalHealthTrackers(),renderSleepTracker(),renderFinance(),animateDashboardItems())},renderAnalytics=debounce(()=>{populateHabitSelector(),renderCorrelationChart(),window.insightsModule?.renderInsightsWidget()},200),updateGreeting=()=>{const e=(new Date).getHours();let t="Hello";t=e<5?"Good Night":e<12?"Good Morning":e<18?"Good Afternoon":"Good Evening";const a=document.getElementById("greeting-text"),o=document.getElementById("greeting-user");a&&(a.innerText=t),o&&(o.innerText=userProfile.displayName?userProfile.displayName.split(" ")[0]:"Friend")},renderUserProfile=()=>{const{level:e=1,xp:t=0,displayName:a,photoURL:o}=userProfile,n=XP_PER_LEVEL+20*(e-1),s=Math.min(100,t/n*100);updateGreeting(),document.getElementById("user-level").innerText=`Level ${e}`,document.getElementById("xp-text").innerText=`${t}/${n} XP`;const r=document.getElementById("xp-ring-circle");if(r){const e=100-s;r.setAttribute("stroke-dashoffset",e)}else{const e=document.getElementById("xp-bar");e&&(e.style.width=`${s}%`)}if(a){const e=document.getElementById("user-name");e&&(e.innerText=a)}if(o){const e=document.getElementById("user-avatar");e&&(e.src=o)}o&&(document.getElementById("user-avatar").src=o)},renderHabitsForToday=()=>{const e=document.getElementById("habits-list"),t=document.getElementById("empty-habits-message"),a=(new Date).toLocaleString("en-US",{weekday:"short"}).toLowerCase(),o=getTodayString();0===habits.length?(e.innerHTML="",t.classList.remove("hidden")):(t.classList.add("hidden"),e.innerHTML=habits.map(e=>{const t=habitLogs[o]?.[e.id],n=t?normalizeStatus(t.status):"pending",s=HABIT_CATEGORIES[e.category]||HABIT_CATEGORIES.other,r=e.frequency?.days?.includes("everyday")||e.frequency?.days?.includes(a);let d="";if(e.isExamPrep&&e.examDate){const t=new Date(e.examDate+"T00:00:00"),a=Math.ceil((t-new Date)/864e5);d=`<span class="text-xs font-semibold px-2 py-0.5 rounded-full" style="background-color: var(--warning); color: white">${a<=0?`${a}d left`:"Today!"}</span>`}let i="";if(!r){i=`<span class="text-xs px-2 py-0.5 rounded-full" style="background-color: var(--secondary); color: white; opacity: 0.7">üìÖ ${e.frequency?.days?.join(", ")||"Not set"}</span>`}return`\n        <div class="habit-item flex items-center justify-between p-3 rounded-lg card ${r?"":"opacity-60"}" data-id="${e.id}" style="border-left: 5px solid ${s.color}">\n          <div class="flex items-center gap-3 overflow-hidden">\n            <span class="text-2xl">${e.icon}</span>\n            <div>\n              <p class="font-semibold truncate">${e.name}</p>\n              <div class="flex items-center gap-2 text-xs" style="color: var(--secondary)">\n                <span>${e.streak||0}üî•</span>\n                <span class="capitalize px-2 py-0.5 rounded-full" style="background-color: ${s.color}20; color: ${s.color}">${s.name}</span>\n                ${d}\n                ${i}\n              </div>\n            </div>\n          </div>\n          <div class="flex items-center gap-1 flex-shrink-0">\n            ${"pending"===n&&r?'\n              <button data-action="complete" class="action-btn p-2 rounded-full hover:bg-green-100 dark:hover:bg-green-800" title="Complete">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2.5"><path d="M20 6 9 17l-5-5"/></svg>\n              </button>\n              <button data-action="skip" class="action-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="Skip">\n                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--secondary)" stroke-width="2.5"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" x2="19" y1="5" y2="19"/></svg>\n              </button>\n            ':"pending"!==n||r?`\n              <span class="capitalize font-semibold text-sm px-3" style="color: ${"completed"===n?"var(--accent)":"skipped"===n?"var(--secondary)":"var(--danger)"}">${n}</span>\n            `:'\n              <span class="text-xs font-semibold px-3 py-1" style="color: var(--secondary)">Not scheduled</span>\n            '}\n            <button data-action="edit" class="action-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700" title="Edit Habit">\n              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--secondary)" stroke-width="2.5"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>\n            </button>\n          </div>\n        </div>\n      `}).join(""))},handleHabitAction=e=>{e.stopPropagation();const t=e.currentTarget.closest(".habit-item");if(!t)return;const a=t.dataset.id,o=e.currentTarget.dataset.action;"complete"===o||"skip"===o?updateHabitStatus(a,o):"edit"===o&&showAddHabitModal(habits.find(e=>e.id===a))},renderDailyProgress=()=>{const e=document.getElementById("daily-progress-circle"),t=document.getElementById("daily-progress-text"),a=(new Date).toLocaleString("en-US",{weekday:"short"}).toLowerCase(),o=getTodayString(),n=habits.filter(e=>e.frequency?.days?.includes("everyday")||e.frequency?.days?.includes(a));if(0===n.length)return void updateProgressCircle(0,e,t);const s=n.filter(e=>{const t=habitLogs[o]?.[e.id]?.status;return isCompleted(t)}).length,r=Math.round(s/n.length*100);updateProgressCircle(r,e,t)},updateProgressCircle=(e,t,a)=>{if(!t||!a)return;const o=100,n=o-e/100*o;t.style.strokeDasharray="100 100",t.style.strokeDashoffset=n,a.textContent=`${e}%`},renderMentalHealthTrackers=()=>{const e=getTodayString(),t=userProfile.moods?.[e],a=userProfile.stress?.[e];document.querySelectorAll(".mood-btn").forEach(e=>{const a=e.dataset.mood===t;e.classList.remove("bg-danger/20","border-danger","bg-accent/20","border-accent","bg-tertiary/15","border-tertiary/60","shadow-neon-tertiary"),e.classList.add("bg-white/10","border-glass-border"),a&&(e.classList.remove("bg-white/10","border-glass-border"),"sad"===e.dataset.mood?e.classList.add("bg-danger/20","border-danger"):"neutral"===e.dataset.mood?e.classList.add("bg-accent/20","border-accent"):"happy"===e.dataset.mood&&e.classList.add("bg-tertiary/15","border-tertiary/60","shadow-neon-tertiary"))}),document.querySelectorAll(".stress-btn").forEach(e=>{const t=e.dataset.stress===a;e.classList.remove("bg-primary","text-white","shadow-neon"),e.classList.add("text-text-muted"),t&&(e.classList.remove("text-text-muted"),e.classList.add("bg-primary","text-white","shadow-neon"))})},renderSleepTracker=()=>{const e=getTodayString(),t=document.getElementById("sleep-hours");t&&(t.value=sleepLogs[e]||"")},renderAssignments=()=>{const e=document.getElementById("assignment-list"),t=document.getElementById("empty-assignments-message");if(!e||!t)return;const a=assignments.filter(e=>!e.completed).sort((e,t)=>new Date(e.dueDate)-new Date(t.dueDate));if(0===a.length)return e.innerHTML="",void t.classList.remove("hidden");t.classList.add("hidden"),e.innerHTML=a.map(e=>{const t=new Date(e.dueDate+"T00:00:00"),a=Math.ceil((t-new Date)/864e5),o=a<=3?"var(--danger)":a<=7?"var(--warning)":"var(--secondary)";return`\n      <div class="flex items-center justify-between p-2 rounded-lg card text-sm">\n        <div>\n          <p class="font-semibold">${e.title}</p>\n          <p style="color:var(--secondary)">${e.subject}</p>\n        </div>\n        <div class="text-right">\n          <p style="color:${o}">${a>0?`${a}d left`:0===a?"Today!":"Overdue"}</p>\n          <button data-id="${e.id}" class="toggle-assignment-btn text-xs" style="color:var(--accent)">Mark Done</button>\n        </div>\n      </div>\n    `}).join("")},renderRewards=()=>{const e=document.getElementById("achievements-grid"),t=achievements.map(e=>e.achievementId);e.innerHTML=Object.entries(ACHIEVEMENTS_LIST).map(([e,a])=>{const o=t.includes(e);return`\n      <div class="card rounded-lg p-4 text-center flex flex-col items-center justify-center ${o?"opacity-100":"opacity-40"}">\n        <div class="text-4xl mb-2">${a.icon}</div>\n        <h3 class="font-bold text-sm">${a.name}</h3>\n        <p class="text-xs mt-1" style="color: var(--secondary);">${a.description}</p>\n        ${o?'<p class="text-xs mt-2 font-bold" style="color: var(--accent);">Unlocked!</p>':""}\n      </div>\n    `}).join("")},updatePomodoroUI=()=>{document.getElementById("pomodoro-timer").textContent=`${String(Math.floor(pomodoro.timeLeft/60)).padStart(2,"0")}:${String(pomodoro.timeLeft%60).padStart(2,"0")}`,document.querySelectorAll(".pomodoro-btn").forEach(e=>e.classList.remove("active")),document.querySelector(`.pomodoro-btn[data-mode="${pomodoro.mode}"]`).classList.add("active"),document.getElementById("pomodoro-start-btn").textContent=pomodoro.isRunning?"Pause":"Start";const e=document.getElementById("pomodoro-cycles");if(e){const t="number"==typeof pomodoro.completedCycles?pomodoro.completedCycles:0;e.textContent=`Cycles: ${t}/4`}if("work"===pomodoro.mode){const e=POMODORO_TIMES.work,t=1-pomodoro.timeLeft/e;drawPlant(t)}else drawPlant(0)},switchPomodoroMode=e=>{stopPomodoro(),pomodoro.mode=e,pomodoro.timeLeft=POMODORO_TIMES[e],updatePomodoroUI()},startPausePomodoro=()=>{if(pomodoro.isRunning=!pomodoro.isRunning,pomodoro.isRunning){const e=Date.now()+1e3*pomodoro.timeLeft;pomodoro.timerId=setInterval(()=>{const t=Date.now();pomodoro.timeLeft=Math.ceil((e-t)/1e3),pomodoro.timeLeft<=0&&(stopPomodoro(),handlePomodoroAutoSwitch()),updatePomodoroUI()},1e3)}else clearInterval(pomodoro.timerId);updatePomodoroUI()},handlePomodoroAutoSwitch=()=>{"work"===pomodoro.mode?(grantAchievement("first_pomodoro"),pomodoro.completedCycles=(pomodoro.completedCycles||0)+1,pomodoro.completedCycles>=4?(pomodoro.completedCycles=0,showToast("Work session complete! Time for a long break ‚ú®"),switchPomodoroMode("longBreak")):(showToast("Work session complete! Time for a short break üß∏"),switchPomodoroMode("shortBreak"))):(showToast("longBreak"===pomodoro.mode?"Long break finished. Ready to focus again!":"Break finished. Back to work!"),switchPomodoroMode("work"))},stopPomodoro=()=>{clearInterval(pomodoro.timerId),pomodoro.isRunning=!1},resetPomodoro=()=>{stopPomodoro(),pomodoro.completedCycles=0,pomodoro.timeLeft=POMODORO_TIMES[pomodoro.mode],updatePomodoroUI()},setMentalHealthValue=async(e,t)=>{const a=getTodayString();if(userProfile[e]||(userProfile[e]={}),userProfile[e][a]=t,renderMentalHealthTrackers(),isLocalMode)localStore.set("profile",userProfile);else{const o=doc(db,`users/${userId}`);await setDoc(o,{[e]:{[a]:t}},{merge:!0})}if("moods"===e&&"sad"===t||"stress"===e&&"high"===t){const e=["Tough day? Take a 5-minute breather. You got this! üíô","It's okay not to be okay. Treat yourself to something nice today. üç´","Remember: This stress is temporary, but your potential is permanent. ‚ú®","Sending you a virtual hug! ü§ó Take it easy for a bit.","Deep breath in... Deep breath out... You are doing your best. üåø"],t=`\n      <div class="modal-content w-full max-w-sm mx-auto p-6 text-center">\n        <div class="text-4xl mb-4">ü´Ç</div>\n        <h3 class="text-xl font-bold mb-2">Hey Dost!</h3>\n        <p class="mb-6 text-lg">${e[Math.floor(Math.random()*e.length)]}</p>\n        <button id="dost-close" class="w-full py-2 rounded-lg font-bold text-white" style="background-color: var(--primary);">Thanks, I needed that</button>\n      </div>`,a=document.createElement("div");a.className="modal-overlay",a.innerHTML=t,document.body.appendChild(a),a.querySelector("#dost-close").addEventListener("click",()=>{a.remove()})}},saveSleepHours=async()=>{const e=document.getElementById("sleep-hours").value;if(""===e||isNaN(e))return;const t=getTodayString();if(isLocalMode)sleepLogs[t]=parseFloat(e),localStore.set("sleepLogs",sleepLogs),renderSleepTracker();else{const a=doc(db,`users/${userId}/sleepLogs`,t);await setDoc(a,{hours:parseFloat(e)})}showToast("Sleep logged!")},updateHabitStatus=async(e,t)=>{const a=getTodayString(),o=normalizeStatus(t);habitLogs[a]||(habitLogs[a]={});const n=habitLogs[a][e],s=n?n.status:null;habitLogs[a][e]={...n||{},id:n?.id||"local_"+Date.now(),userId:userId,habitId:e,date:a,status:o},renderDashboard();try{if(isLocalMode)localStore.set("habitLogs",habitLogs);else{const t=n;let s;if(t&&t.id&&!t.id.startsWith("temp_")&&!t.id.startsWith("local_"))s=doc(db,`users/${userId}/logs`,t.id);else{const t=query(collection(db,`users/${userId}/logs`),where("date","==",a),where("habitId","==",e)),o=await getDocs(t);s=o.empty?doc(collection(db,`users/${userId}/logs`)):o.docs[0].ref}await setDoc(s,{userId:userId,habitId:e,date:a,status:o},{merge:!0})}const t=normalizeStatus(s);if("completed"===o&&"completed"!==t){await addXP(e),await updateStreak(e,"increment"),await grantAchievement("first_habit");const t=new Date,a=t.getHours(),o=t.getDay();(a>=22||a<4)&&await grantAchievement("night_owl"),a>=4&&a<7&&await grantAchievement("early_bird"),0!==o&&6!==o||await grantAchievement("weekend_warrior")}else"failed"===o&&await updateStreak(e,"reset");await checkPerfectDayAchievement()}catch(t){console.error("Optimistic update failed:",t),n?habitLogs[a][e]=n:delete habitLogs[a][e],renderDashboard(),showToast("Failed to update status. Please try again.","error")}},addXP=async e=>{const t=habits.find(t=>t.id===e);if(!t)return;const a=XP_PER_DIFFICULTY[t.difficulty]||10,o=userProfile.xp||0,n=userProfile.level||1;let s=o+a,r=n;const d=XP_PER_LEVEL+20*(n-1);s>=d&&(r++,s-=d,showToast(`Level Up! You've reached Level ${r}!`)),userProfile.xp=s,userProfile.level=r,isLocalMode?localStore.set("profile",userProfile):await updateDoc(doc(db,`users/${userId}`),{xp:s,level:r})},updateStreak=async(e,t)=>{const a=habits.find(t=>t.id===e);if(!a)return;let o=a.streak||0,n=!1;if("increment"===t){const t=new Date;t.setDate(t.getDate()-1);const a=habitLogs[getDateString(t)]?.[e];isCompleted(a?.status)?o+=1:(o>0&&(n=!0),o=1)}else"reset"===t&&(o>0&&(n=!0),o=0);const s=Math.max(a.bestStreak||0,o);if(a.streak=o,a.bestStreak=s,isLocalMode)localStore.setArray("habits",habits);else{const t=doc(db,`users/${userId}/habits`,e);await updateDoc(t,{streak:o,bestStreak:s})}if(o>=7&&await grantAchievement("7_day_streak"),n){if(!habits.some(t=>t.id!==e&&(t.streak||0)>=7)){const e=achievements.find(e=>"7_day_streak"===e.achievementId);e&&(isLocalMode?(achievements=achievements.filter(t=>t.id!==e.id),localStore.setArray("achievements",achievements)):await deleteDoc(doc(db,`users/${userId}/achievements`,e.id)),showToast("Streak broken! Week Warrior status lost. üò¢"))}}},checkPerfectDayAchievement=async()=>{const e=(new Date).toLocaleString("en-US",{weekday:"short"}).toLowerCase(),t=getTodayString(),a=habits.filter(t=>t.frequency?.days?.includes("everyday")||t.frequency?.days?.includes(e));if(0===a.length)return;a.every(e=>{const a=habitLogs[t]?.[e.id]?.status;return isCompleted(a)})&&await grantAchievement("perfect_day")},grantAchievement=async e=>{if(achievements.some(t=>t.achievementId===e))return;const t={achievementId:e,dateEarned:(new Date).toISOString()};isLocalMode?(t.id="local_"+Date.now(),achievements.push(t),localStore.setArray("achievements",achievements)):await addDoc(collection(db,`users/${userId}/achievements`),t),showToast(`Achievement Unlocked: ${ACHIEVEMENTS_LIST[e].name}!`)},showAddHabitModal=(e=null)=>{const t=!!e,a=`\n    <div class="modal-content w-full max-w-md mx-auto">\n      <form id="habit-form" class="flex flex-col">\n        <div class="p-6 space-y-4 max-h-[80vh] overflow-y-auto custom-scrollbar">\n          <h3 class="text-lg font-bold">${t?"Edit Habit":"Add New Habit"}</h3>\n          <div class="flex gap-2">\n            <input type="text" name="icon" placeholder="üéØ" value="${e?.icon||""}" class="w-16 text-2xl text-center p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n            <input type="text" name="name" placeholder="Habit Name" value="${e?.name||""}" class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);" required>\n          </div>\n          <div>\n            <label class="text-sm font-medium">Category</label>\n            <select name="category" class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n              ${Object.entries(HABIT_CATEGORIES).map(([t,a])=>`<option value="${t}" ${e?.category===t?"selected":""}>${a.name}</option>`).join("")}\n            </select>\n          </div>\n          <div>\n            <label class="text-sm font-medium">Difficulty</label>\n            <select name="difficulty" class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n              <option value="easy" ${"easy"===e?.difficulty?"selected":""}>Easy</option>\n              <option value="medium" ${"medium"===e?.difficulty?"selected":""}>Medium</option>\n              <option value="hard" ${"hard"===e?.difficulty?"selected":""}>Hard</option>\n            </select>\n          </div>\n          <div>\n            <label class="text-sm font-medium mb-2 block">Frequency</label>\n            <div class="flex flex-wrap gap-2 frequency-days">\n              <button type="button" data-day="everyday" class="freq-btn p-2 rounded-md border text-sm">Everyday</button>\n              ${["sun","mon","tue","wed","thu","fri","sat"].map(e=>`<button type="button" data-day="${e}" class="freq-btn p-2 rounded-md border w-10 text-sm capitalize">${e}</button>`).join("")}\n            </div>\n          </div>\n          <div class="flex items-center">\n            <input type="checkbox" id="exam-prep-toggle" name="isExamPrep" ${e?.isExamPrep?"checked":""}>\n            <label for="exam-prep-toggle" class="ml-2">Exam Preparation Habit</label>\n          </div>\n          <div id="exam-date-container" class="${e?.isExamPrep?"":"hidden"}">\n            <label for="exam-date" class="text-sm font-medium">Exam Date</label>\n            <input type="date" name="examDate" value="${e?.examDate||""}" class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n          </div>\n        </div>\n        <div class="p-4 flex justify-end gap-3" style="background-color: var(--background); border-top: 1px solid var(--card-border);">\n          ${t?'<button type="button" id="delete-habit-btn" class="font-bold py-2 px-4 rounded-lg" style="color: var(--danger);">Delete</button>':""}\n          <button type="button" class="cancel-btn font-bold py-2 px-4">Cancel</button>\n          <button type="submit" class="text-white font-bold py-2 px-4 rounded-lg" style="background-color: var(--primary);">${t?"Save":"Create"}</button>\n        </div>\n      </form>\n    </div>`;modalContainer.innerHTML=a,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex");const o=modalContainer.querySelector(".frequency-days"),n=new Set(e?.frequency?.days||["everyday"]),s=()=>{o.querySelectorAll(".freq-btn").forEach(e=>{n.has(e.dataset.day)?(e.style.backgroundColor="var(--primary)",e.style.color="var(--primary-foreground)"):(e.style.backgroundColor="transparent",e.style.color="var(--foreground)")})};o.addEventListener("click",e=>{if(!e.target.classList.contains("freq-btn"))return;const t=e.target.dataset.day;"everyday"===t?(n.clear(),n.add("everyday")):(n.delete("everyday"),n.has(t)?n.delete(t):n.add(t)),s()}),s(),modalContainer.querySelector("#exam-prep-toggle").addEventListener("change",e=>{modalContainer.querySelector("#exam-date-container").classList.toggle("hidden",!e.target.checked)}),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal),modalContainer.querySelector("#habit-form").addEventListener("submit",async a=>{a.preventDefault();const o=new FormData(a.target),s={name:o.get("name"),icon:o.get("icon"),category:o.get("category"),difficulty:o.get("difficulty"),frequency:{type:"weekly",days:Array.from(n)},isExamPrep:"on"===o.get("isExamPrep"),examDate:o.get("examDate")||null,streak:e?.streak||0,bestStreak:e?.bestStreak||0,createdAt:e?.createdAt||(new Date).toISOString()};if(isLocalMode){if(t){const t=habits.findIndex(t=>t.id===e.id);-1!==t&&(habits[t]={...habits[t],...s})}else s.id="local_"+Date.now(),habits.push(s);localStore.setArray("habits",habits),renderDashboard()}else{const a=t?doc(db,`users/${userId}/habits`,e.id):collection(db,`users/${userId}/habits`);t?await updateDoc(a,s):await addDoc(a,s)}closeModal()}),t&&modalContainer.querySelector("#delete-habit-btn").addEventListener("click",async()=>{if(await showConfirmModal("Are you sure you want to delete this habit and all its history? This action cannot be undone.")){if(isLocalMode){habits=habits.filter(t=>t.id!==e.id);for(const t in habitLogs)habitLogs[t][e.id]&&delete habitLogs[t][e.id];localStore.setArray("habits",habits),localStore.set("habitLogs",habitLogs),renderDashboard()}else{await deleteDoc(doc(db,`users/${userId}/habits`,e.id));const t=query(collection(db,`users/${userId}/logs`),where("habitId","==",e.id)),a=await getDocs(t),o=writeBatch(db);a.docs.forEach(e=>o.delete(e.ref)),await o.commit()}showToast("Habit deleted."),closeModal()}})},showConfirmModal=e=>new Promise(t=>{const a=`\n      <div class="modal-content w-full max-w-sm mx-auto p-6 text-center">\n        <p class="mb-6">${e}</p>\n        <div class="flex justify-center gap-4">\n          <button id="confirm-cancel" class="font-bold py-2 px-6 rounded-lg">Cancel</button>\n          <button id="confirm-ok" class="text-white font-bold py-2 px-6 rounded-lg" style="background-color: var(--danger);">Confirm</button>\n        </div>\n      </div>`,o=document.createElement("div");o.className="modal-overlay",o.innerHTML=a,document.body.appendChild(o),o.querySelector("#confirm-ok").addEventListener("click",()=>{o.remove(),t(!0)}),o.querySelector("#confirm-cancel").addEventListener("click",()=>{o.remove(),t(!1)})}),showAssignmentModal=(e=null)=>{const t=!!e,a=`\n    <div class="modal-content w-full max-w-sm mx-auto">\n      <form id="assignment-form" class="flex flex-col">\n        <div class="p-6 space-y-4">\n          <h3 class="text-lg font-bold">${t?"Edit Assignment":"Add Assignment"}</h3>\n          <input name="title" placeholder="Assignment Title" value="${e?.title||""}" required class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n          <input name="subject" placeholder="Subject" value="${e?.subject||""}" required class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n          <input name="dueDate" type="date" value="${e?.dueDate||""}" required class="w-full p-2 rounded-md border" style="background-color: var(--background); border-color: var(--card-border);">\n        </div>\n        <div class="p-4 flex justify-end gap-3" style="background-color: var(--background); border-top: 1px solid var(--card-border);">\n          <button type="button" class="cancel-btn font-bold py-2 px-4">Cancel</button>\n          <button type="submit" class="text-white font-bold py-2 px-4 rounded-lg" style="background-color: var(--primary);">${t?"Save":"Add"}</button>\n        </div>\n      </form>\n    </div>`;modalContainer.innerHTML=a,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal),modalContainer.querySelector("#assignment-form").addEventListener("submit",async a=>{a.preventDefault();const o=new FormData(a.target),n={title:o.get("title"),subject:o.get("subject"),dueDate:o.get("dueDate"),completed:e?.completed||!1,type:"assignment"};if(isLocalMode){if(t){const t=assignments.findIndex(t=>t.id===e.id);-1!==t&&(assignments[t]={...assignments[t],...n})}else n.id="local_"+Date.now(),assignments.push(n);localStore.setArray("assignments",assignments),renderDashboard(),renderAssignments()}else{const a=t?doc(db,`users/${userId}/academics`,e.id):collection(db,`users/${userId}/academics`);t?await updateDoc(a,n):await addDoc(a,n)}closeModal()})},showGradeModal=()=>{modalContainer.innerHTML='\n    <div class="modal-content w-full max-w-sm mx-auto animate-fade-in-up">\n      <form id="grade-form" class="flex flex-col">\n        <div class="p-6 space-y-4">\n          <h3 class="text-lg font-bold">Log a Grade</h3>\n          <p class="text-sm text-text-muted">Track your performance to identify weak subjects.</p>\n          \n          <div>\n            <label class="text-xs font-medium text-text-muted mb-1 block">Subject</label>\n            <input name="subject" placeholder="e.g. Mathematics" list="subjects-list" required \n              class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-primary focus:ring-1 focus:ring-primary outline-none">\n            <datalist id="subjects-list">\n              <option value="Mathematics">\n              <option value="Physics">\n              <option value="Chemistry">\n              <option value="Biology">\n              <option value="Computer Science">\n              <option value="English">\n              <option value="History">\n            </datalist>\n          </div>\n\n          <div>\n            <label class="text-xs font-medium text-text-muted mb-1 block">Score / Percentage</label>\n            <input name="grade" type="number" step="0.1" min="0" max="100" placeholder="0-100" required \n              class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-primary focus:ring-1 focus:ring-primary outline-none">\n          </div>\n        </div>\n        <div class="p-4 flex justify-end gap-3 border-t border-glass-border bg-white/5">\n          <button type="button" class="cancel-btn font-bold py-2 px-4 text-text-muted hover:text-text-default transition-colors">Cancel</button>\n          <button type="submit" class="text-white font-bold py-2 px-6 rounded-xl bg-primary shadow-neon hover:bg-primary/90 transition-all">Log Grade</button>\n        </div>\n      </form>\n    </div>',modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal),setTimeout(()=>modalContainer.querySelector('input[name="subject"]').focus(),100),modalContainer.querySelector("#grade-form").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),a={subject:t.get("subject"),grade:parseFloat(t.get("grade")),date:getTodayString(),timestamp:(new Date).toISOString(),type:"grade"};isLocalMode?(a.id="local_"+Date.now(),grades.push(a),localStore.setArray("grades",grades),renderAcademicRadar(),renderCorrelationChart(),showToast("Grade logged successfully! üìà")):(await addDoc(collection(db,`users/${userId}/academics`),a),showToast("Grade logged successfully! üìà")),grantAchievement("grade_guru"),closeModal()})},showGradeHistoryModal=()=>{const e=[...grades].sort((e,t)=>new Date(t.timestamp||t.date)-new Date(e.timestamp||e.date)),t=`\n    <div class="modal-content w-full max-w-md mx-auto p-0 overflow-hidden h-[70vh] flex flex-col animate-fade-in-up">\n      <div class="p-4 border-b border-glass-border flex justify-between items-center bg-glass-panel">\n        <h3 class="text-lg font-bold text-text-default flex items-center gap-2">\n            <span class="material-symbols-outlined text-primary">history_edu</span>\n            Grade History\n        </h3>\n        <button class="cancel-btn text-text-muted hover:text-text-default transition-colors">\n            <span class="material-symbols-outlined">close</span>\n        </button>\n      </div>\n      \n      <div class="grade-history-list flex-1 overflow-y-auto p-4 custom-scrollbar space-y-2">\n        ${e.length>0?e.map(e=>`\n        <div class="grade-row flex justify-between items-center p-3 bg-white/5 border border-glass-border rounded-xl mb-2 hover:bg-white/10 transition-colors" data-id="${e.id}">\n            <div class="flex items-center gap-3">\n                <div class="w-10 h-10 rounded-full bg-primary/20 text-primary flex items-center justify-center font-bold text-lg">\n                    ${e.grade>0?Math.round(e.grade):"-"}\n                </div>\n                <div>\n                    <div class="font-bold text-text-default capitalize">${e.subject}</div>\n                    <div class="text-xs text-text-muted">${e.date}</div>\n                </div>\n            </div>\n            <button class="delete-grade-btn text-xs px-3 py-1.5 rounded-lg bg-danger/10 text-danger hover:bg-danger/20 border border-danger/20 transition-all font-medium" \n                data-id="${e.id}" type="button">Delete</button>\n        </div>\n    `).join(""):'<div class="text-center text-text-muted py-12 flex flex-col items-center gap-2"><span class="material-symbols-outlined text-4xl opacity-50">description</span><p>No grades logged yet.</p></div>'}\n      </div>\n    </div>`;modalContainer.innerHTML=t,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal);const a=modalContainer.querySelector(".grade-history-list");a?.addEventListener("click",async e=>{if(e.target.classList.contains("delete-grade-btn")){const t=e.target.dataset.id;await showConfirmModal("Delete this grade record?")&&(await deleteGrade(t),e.target.closest(".grade-row")?.remove(),renderAcademicRadar(),renderCorrelationChart())}})},deleteGrade=async e=>{if(userId||isLocalMode)try{isLocalMode?(grades=grades.filter(t=>t.id!==e),localStore.setArray("grades",grades)):await deleteDoc(doc(db,`users/${userId}/academics`,e)),showToast("Grade deleted.")}catch(e){console.error("Error deleting grade:",e),showToast("Failed to delete grade.")}},closeModal=()=>{modalContainer.innerHTML="",modalContainer.classList.add("hidden"),modalContainer.classList.remove("flex")},populateHabitSelector=()=>{const e=document.getElementById("habit-analytics-selector"),t=e.value;if(e.innerHTML='<option value="">-- Select a Habit for Deep Dive --</option>',habits.forEach(a=>{e.innerHTML+=`<option value="${a.id}" ${a.id===t?"selected":""}>${a.name}</option>`}),!t&&habits.length>0){e.value=habits[0].id;const t=document.getElementById("deep-dive-content");t&&(t.classList.remove("hidden"),renderTrendChart(habits[0].id),renderHeatmap(habits[0].id))}},cssVar=e=>getComputedStyle(document.documentElement).getPropertyValue(e).trim();function renderCorrelationChart(){const e=document.getElementById("correlation-chart");if(!e)return;setFixedChartSize(e,320);const t=e.getContext("2d");correlationChartInstance&&correlationChartInstance.destroy(),correlationChartInstance=null;const a=[],o=new Date;for(let e=29;e>=0;e--){const t=new Date(o);t.setDate(t.getDate()-e),a.push(getDateString(t))}const n=grades&&grades.length>0,s=n?userProfile.moods:SAMPLE_MOODS,r=n?sleepLogs:SAMPLE_SLEEP,d=(cssVar("--primary"),cssVar("--warning")),i=cssVar("--accent"),l=cssVar("--danger"),c={sad:1,neutral:2,happy:3},u={low:1,medium:2,high:3},m=a.map(e=>{const t=userProfile.stress?.[e];return t?u[t]:null}),g=a.map(e=>s[e]?c[s[e]]:null),p=a.map(e=>r[e]||null),y=document.getElementById("analytics-info-message");y&&(y.style.display="none"),correlationChartInstance=new Chart(t,{type:"line",data:{labels:a,datasets:[{label:"Stress",data:m,borderColor:l,yAxisID:"y",tension:.1,fill:!1,spanGaps:!0},{label:"Mood",data:g,borderColor:d,yAxisID:"y1",tension:.1,fill:!1,spanGaps:!0},{label:"Sleep hours",data:p,borderColor:i,yAxisID:"y1",tension:.1,fill:!1,spanGaps:!0}]},options:{responsive:!0,maintainAspectRatio:!1,devicePixelRatio:2,animation:!1,scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"MMM d"},grid:{color:"rgba(255, 255, 255, 0.05)"},ticks:{maxRotation:0,autoSkip:!0,color:"#94a3b8",font:{size:11,weight:"bold"}}},y:{position:"left",title:{display:!0,text:"Stress Level",color:"#94a3b8"},min:0,max:4,grid:{color:"rgba(255, 255, 255, 0.05)"},ticks:{stepSize:1,callback:function(e){return 1===e?"Low":2===e?"Med":3===e?"High":""},color:"#94a3b8",font:{size:11,weight:"bold"}}},y1:{position:"right",display:!1,min:0}},plugins:{legend:{position:"top",labels:{boxWidth:10,color:"#94a3b8",font:{size:12,weight:"bold"},padding:20}}}}}),renderAcademicRadar(),renderBurnoutMeter(),renderCGPASimulator()}let cgpaSubjects=[];const renderCGPASimulator=async()=>{const e=document.getElementById("cgpa-subjects-list"),t=document.getElementById("add-cgpa-subject-btn"),a=document.getElementById("prev-cgpa-input"),o=document.getElementById("prev-credits-input");if(e&&t){if(0===cgpaSubjects.length)if(isLocalMode){const e=localStore.get("cgpaData");e&&e.subjects&&(cgpaSubjects=e.subjects||[],a&&(a.value=e.prevCGPA||""),o&&(o.value=e.prevCredits||""))}else if(userId)try{const e=doc(db,`users/${userId}/simulations/cgpa_data`),t=await getDoc(e);if(t.exists()){const e=t.data();cgpaSubjects=e.subjects||[],a&&(a.value=e.prevCGPA||""),o&&(o.value=e.prevCredits||"")}else if(userProfile.cgpaSubjects&&userProfile.cgpaSubjects.length>0)cgpaSubjects=[...userProfile.cgpaSubjects];else{const e=[...new Set(grades.map(e=>e.subject))];cgpaSubjects=e.length>0?e.map(e=>{const t=grades.filter(t=>t.subject===e).map(e=>e.grade),a=Math.round(t.reduce((e,t)=>e+t,0)/t.length);return{name:e,credits:3,marks:a,maxMarks:100}}):[{name:"Math",credits:4,marks:85,maxMarks:100},{name:"Physics",credits:3,marks:78,maxMarks:100}]}}catch(e){console.error("Error loading CGPA data:",e)}e.innerHTML="",cgpaSubjects.forEach((t,a)=>{const o=document.createElement("div");o.className="flex flex-wrap sm:flex-nowrap items-center gap-2 bg-white dark:bg-slate-700 p-2 rounded-lg shadow-sm border border-gray-100 dark:border-slate-600",o.innerHTML=`\n      <div class="w-full sm:w-1/3 flex justify-between items-center sm:block mb-2 sm:mb-0">\n        <input type="text" value="${t.name}" class="bg-transparent border-none text-sm font-medium focus:ring-0 p-0 w-full" onchange="window.updateCGPASubject(${a}, 'name', this.value)">\n        <div class="flex items-center gap-1 sm:mt-1">\n            <label class="text-[10px] text-gray-400">Max:</label>\n            <input type="number" value="${t.maxMarks||100}" min="10" class="w-10 bg-gray-100 dark:bg-slate-600 rounded p-0.5 text-[10px] text-center" onchange="window.updateCGPASubject(${a}, 'maxMarks', this.value)">\n        </div>\n      </div>\n      <div class="flex items-center gap-2 w-full sm:w-auto">\n          <div class="flex flex-col items-center w-10 shrink-0">\n            <label class="text-[10px] text-gray-400">Cr</label>\n            <input type="number" value="${t.credits}" min="1" max="10" class="w-full text-center bg-gray-100 dark:bg-slate-600 rounded p-1 text-xs" onchange="window.updateCGPASubject(${a}, 'credits', this.value)">\n          </div>\n          <div class="flex-1 flex items-center gap-2 min-w-0">\n            <input type="range" min="0" max="${t.maxMarks||100}" value="${t.marks}" class="w-full h-1.5 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600 accent-primary" oninput="window.updateCGPASubject(${a}, 'marks', this.value)">\n            <span class="text-xs w-8 text-right font-mono shrink-0">${t.marks}</span>\n          </div>\n          <button class="text-gray-400 hover:text-red-500 px-1 shrink-0" onclick="window.removeCGPASubject(${a})">&times;</button>\n      </div>\n    `,e.appendChild(o)}),t.onclick=()=>{cgpaSubjects.push({name:`Subject ${cgpaSubjects.length+1}`,credits:3,marks:80,maxMarks:100}),renderCGPASimulator(),saveCGPASubjects()},calculateCGPA()}},saveCGPASubjects=debounce(async()=>{if(!userId)return;const e=parseFloat(document.getElementById("prev-cgpa-input")?.value)||0,t=parseFloat(document.getElementById("prev-credits-input")?.value)||0,a={subjects:cgpaSubjects,prevCGPA:e,prevCredits:t,lastUpdated:(new Date).toISOString()};if(isLocalMode)localStore.set("cgpaData",a);else{const e=doc(db,`users/${userId}/simulations/cgpa_data`);await setDoc(e,a,{merge:!0})}},1e3);window.updateCGPASubject=(e,t,a)=>{if("credits"!==t&&"marks"!==t&&"maxMarks"!==t||(a=parseFloat(a)||0),"maxMarks"===t)return cgpaSubjects[e].maxMarks=a,cgpaSubjects[e].marks>a&&(cgpaSubjects[e].marks=a),renderCGPASimulator(),void saveCGPASubjects();if(cgpaSubjects[e][t]=a,"marks"===t){document.getElementById("cgpa-subjects-list").children[e].querySelector("span").innerText=a}calculateCGPA(),saveCGPASubjects()},window.removeCGPASubject=e=>{cgpaSubjects.splice(e,1),renderCGPASimulator(),saveCGPASubjects()};const calculateCGPA=()=>{let e=0,t=0;cgpaSubjects.forEach(a=>{const o=a.maxMarks||100,n=a.marks/o*100;let s=0;s=n>=80?10:n>=75?9:n>=70?8:n>=60?7:n>=50?6:n>=45?5:n>=40?4:0,e+=s*a.credits,t+=a.credits});const a=parseFloat(document.getElementById("prev-cgpa-input")?.value)||0,o=parseFloat(document.getElementById("prev-credits-input")?.value)||0,n=o+t,s=n>0?((a*o+e)/n).toFixed(2):"0.00",r=document.getElementById("projected-cgpa");r&&(r.innerText=s,r.className=s>=9?"text-5xl font-bold text-green-500 transition-all duration-300":s>=7.5?"text-5xl font-bold text-blue-500 transition-all duration-300":s>=6?"text-5xl font-bold text-yellow-500 transition-all duration-300":"text-5xl font-bold text-red-500 transition-all duration-300")};window.calculateCGPA=calculateCGPA;let academicRadarInstance=null;const renderAcademicRadar=()=>{const e=document.getElementById("academic-radar-chart"),t=document.getElementById("radar-empty-state");if(!e)return;const a={};grades.forEach(e=>{const t=e.subject||"Unknown";a[t]||(a[t]=[]),a[t].push(parseFloat(e.grade))});const o=Object.keys(a);if(0===o.length)return e.style.opacity="0.1",void t.classList.remove("hidden");e.style.opacity="1",t.classList.add("hidden");const n=o.map(e=>(a[e].reduce((e,t)=>e+t,0)/a[e].length).toFixed(1));academicRadarInstance&&academicRadarInstance.destroy();const s=e.getContext("2d"),r="dark"===document.documentElement.getAttribute("data-theme"),d=r?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.1)",i=r?"#94a3b8":"#64748b",l=o.length<3?"bar":"radar";academicRadarInstance=new Chart(s,{type:l,data:{labels:o,datasets:[{label:"Average Grade (%)",data:n,fill:!0,backgroundColor:"rgba(99, 102, 241, 0.2)",borderColor:"rgb(99, 102, 241)",pointBackgroundColor:"rgb(99, 102, 241)",pointBorderColor:"#fff",pointHoverBackgroundColor:"#fff",pointHoverBorderColor:"rgb(99, 102, 241)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,scales:"radar"===l?{r:{angleLines:{color:d},grid:{color:d},pointLabels:{color:i,font:{size:12}},min:0,max:100,ticks:{backdropColor:"transparent",color:i,stepSize:20}}}:{y:{beginAtZero:!0,max:100,grid:{color:d},ticks:{color:i}},x:{grid:{display:!1},ticks:{color:i}}},plugins:{legend:{display:!1}}}})},renderBurnoutMeter=()=>{const e=document.getElementById("burnout-liquid"),t=document.getElementById("burnout-percentage"),a=document.getElementById("burnout-status"),o=document.getElementById("burnout-advice");if(!e)return;const n=new Date;let s=0,r=0;for(let e=0;e<7;e++){const t=new Date;t.setDate(n.getDate()-e);const a=getDateString(t);sleepLogs[a]&&(s+=parseFloat(sleepLogs[a]),r++)}const d=r>0?s/r:0;let i=0;i=d>=7?100:d<=4?0:(d-4)/3*100;let l=0,c=0;const u={low:100,medium:50,high:0};for(let e=0;e<7;e++){const t=new Date;t.setDate(n.getDate()-e);const a=getDateString(t),o=userProfile.stress?.[a];o&&void 0!==u[o]&&(l+=u[o],c++)}const m=c>0?l/c:50;let g=0,p=0;const y=habits.length;for(let e=0;e<7;e++){const t=new Date;t.setDate(n.getDate()-e);const a=getDateString(t),o=habitLogs[a]||{};let s=0;Object.values(o).forEach(e=>{isCompleted(e.status)&&s++}),y>0&&(g+=s/y*100,p++)}const b=p>0?g/p:0;let h=0,v=0===r&&0===c&&0===p;if(e.className="w-full rounded-lg absolute bottom-1 left-1 right-1 z-0",v)return a.innerText="No Data",o.innerText="Start logging sleep, mood, and habits to see your energy levels.",gsap.to(e,{height:"15%",duration:1,ease:"power2.out"}),e.classList.add("bg-gray-300","dark:bg-gray-600"),void(t.innerText="--");h=.4*i+.3*m+.3*b,isNaN(h)&&(h=0),h=Math.max(0,Math.min(100,Math.round(h))),gsap.to(e,{height:`${h}%`,duration:1.5,ease:"elastic.out(1, 0.5)"});const f={val:parseFloat(t.innerText)||0};gsap.to(f,{val:h,duration:1.5,ease:"power2.out",onUpdate:()=>{t.innerText=Math.round(f.val)+"%"}});let x="bg-green-500",w="Fully Charged ‚ö°",L="You are doing great! Keep maintaining this balance.";h<30?(x="bg-red-500",w="Critical Burnout ‚ö†Ô∏è",L="Stop studying. Take a nap and do a breathing exercise immediately."):h<60&&(x="bg-yellow-500",w="Draining Fast üîã",L="You are pushing too hard. Prioritize sleep tonight."),e.classList.add(x),a.innerText=w,o.innerText=L},renderTrendChart=e=>{const t=document.getElementById("trends-chart");if(!t)return;const a=t.getContext("2d"),o=Chart.getChart?Chart.getChart(t):trendsChartInstance;o&&o.destroy(),trendsChartInstance=null;const n=new Date,s=[];for(let t=29;t>=0;t--){const a=new Date(n);a.setDate(a.getDate()-t);const o=a.toISOString().split("T")[0],r=habitLogs[o]?.[e],d=isCompleted(r?.status)?1:r?0:null;s.push({x:o,y:d})}const r=cssVar("--accent"),d=cssVar("--danger"),i=s.map(e=>1===e.y?r:d);trendsChartInstance=new Chart(a,{type:"bar",data:{datasets:[{label:"Completion Status",data:s,backgroundColor:i,borderColor:"transparent",borderRadius:4,barPercentage:.6,parsing:{xAxisKey:"x",yAxisKey:"y"}}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:500},scales:{x:{type:"time",time:{unit:"day",tooltipFormat:"MMM d"},grid:{display:!1},ticks:{color:"#94a3b8",font:{size:10,weight:"bold"},maxRotation:0,autoSkip:!0}},y:{display:!1,min:0,max:1.2}},plugins:{legend:{display:!1},tooltip:{backgroundColor:"rgba(15, 23, 42, 0.9)",titleColor:"#f8fafc",bodyColor:"#cbd5e1",padding:10,cornerRadius:8,callbacks:{label:e=>1===e.parsed.y?"Completed":"Not Completed"}}}}})},renderHeatmap=e=>{const t=document.getElementById("heatmap-container");if(!t)return;t.innerHTML="";const a=new Date,o=[];for(let t=29;t>=0;t--){const n=new Date(a);n.setDate(n.getDate()-t);const s=getDateString(n),r=habitLogs[s]?.[e];let d,i;isCompleted(r?.status)?(d=cssVar("--accent"),i="Completed"):isSkipped(r?.status)?(d=cssVar("--secondary"),i="Skipped"):isFailed(r?.status)?(d=cssVar("--danger"),i="Failed"):(d=cssVar("--card-border"),i="No data"),o.push(`\n      <div \n        class="heatmap-cell w-full aspect-square rounded cursor-pointer transition-transform hover:scale-110" \n        style="background-color: ${d};" \n        title="${s}: ${i}"\n        data-date="${s}">\n      </div>\n    `)}t.innerHTML=o.join("")},renderFinance=()=>{const e=document.getElementById("monthly-spend"),t=document.getElementById("monthly-limit"),a=document.getElementById("spend-bar");if(!e)return;const o=(new Date).toISOString().slice(0,7),n=expenses.filter(e=>e.date.startsWith(o)).reduce((e,t)=>e+(parseFloat(t.amount)||0),0),s=userProfile.dailyLimit||2e3;e.innerText=`‚Çπ${n}`,t.innerText=s;const r=Math.min(100,n/s*100);a.style.width=`${r}%`,r>=100?(a.className="h-2.5 rounded-full bg-red-500",e.classList.add("text-red-500")):r>=80?(a.className="h-2.5 rounded-full bg-yellow-500",e.classList.remove("text-red-500")):(a.className="h-2.5 rounded-full bg-green-500",e.classList.remove("text-red-500"))},addExpense=async(e,t,a="")=>{if(!userId)return;const o={amount:parseFloat(e),category:t,description:a,date:(new Date).toISOString()};isLocalMode?(o.id="local_"+Date.now(),expenses.push(o),localStore.setArray("expenses",expenses),renderDashboard()):await addDoc(collection(db,`users/${userId}/finance`),o),showToast(`Added ‚Çπ${e} for ${t}`)},deleteExpense=async e=>{if(userId&&e)try{isLocalMode?(expenses=expenses.filter(t=>t.id!==e),localStore.setArray("expenses",expenses),renderDashboard(),showToast("Expense deleted")):(await deleteDoc(doc(db,`users/${userId}/finance`,e)),showToast("Expense deleted"))}catch(e){console.error("Delete expense error:",e),showToast("Failed to delete expense")}},renderExams=()=>{const e=document.getElementById("exam-list"),t=document.getElementById("empty-exams-message");if(!e)return;e.innerHTML="";const a=[...exams].sort((e,t)=>new Date(e.date)-new Date(t.date));0!==a.length?(t&&t.classList.add("hidden"),a.forEach(t=>{const a=new Date(t.date),o=new Date,n=Math.ceil((a-o)/864e5);let s="text-secondary",r=`${n} days left`;n<0?(s="text-text-muted",r="Completed"):0===n?(s="text-danger",r="Today!"):n<=3&&(s="text-accent",r=`${n} days left`);const d=document.createElement("div");d.className="flex items-center justify-between p-4 bg-white/5 border border-glass-border rounded-xl hover:bg-white/10 transition-colors",d.innerHTML=`\n      <div class="flex-1">\n        <div class="font-bold text-text-default">${t.subject}</div>\n        <div class="text-xs text-text-muted">${a.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}</div>\n        ${t.notes?`<div class="text-xs text-text-muted mt-1 opacity-70">${t.notes}</div>`:""}\n      </div>\n      <div class="flex items-center gap-3">\n        <span class="text-xs font-bold ${s}">${r}</span>\n        <button class="delete-exam-btn text-danger hover:bg-danger/20 p-2 rounded-lg transition-colors" data-id="${t.id}" type="button" aria-label="Delete exam">\n          <span class="material-symbols-outlined text-sm">delete</span>\n        </button>\n      </div>\n    `,d.querySelector(".delete-exam-btn").onclick=()=>deleteExam(t.id),e.appendChild(d)})):t&&t.classList.remove("hidden")},addExam=async(e,t,a="")=>{if(!userId)return;const o={subject:e,date:t,notes:a,createdAt:(new Date).toISOString()};isLocalMode?(o.id="local_"+Date.now(),exams.push(o),localStore.setArray("exams",exams),renderExams()):await addDoc(collection(db,`users/${userId}/exams`),o),showToast(`Exam "${e}" added! üìù`)},deleteExam=async e=>{if(userId&&e)try{isLocalMode?(exams=exams.filter(t=>t.id!==e),localStore.setArray("exams",exams),renderExams(),showToast("Exam deleted")):(await deleteDoc(doc(db,`users/${userId}/exams`,e)),showToast("Exam deleted"))}catch(e){console.error("Delete exam error:",e),showToast("Failed to delete exam")}},showAddExamModal=()=>{modalContainer.innerHTML='\n    <div class="modal-content w-full max-w-sm mx-auto animate-fade-in-up">\n      <form id="exam-form" class="flex flex-col">\n        <div class="p-6 space-y-4">\n          <h3 class="text-lg font-bold text-text-default">Add Exam</h3>\n          <p class="text-sm text-text-muted">Track your upcoming exams and stay prepared.</p>\n          \n          <div>\n            <label class="text-xs font-medium text-text-muted mb-1 block">Subject</label>\n            <input name="subject" placeholder="e.g. Mathematics" required \n              class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-secondary focus:ring-1 focus:ring-secondary outline-none">\n          </div>\n\n          <div>\n            <label class="text-xs font-medium text-text-muted mb-1 block">Exam Date</label>\n            <input name="date" type="date" required \n              class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-secondary focus:ring-1 focus:ring-secondary outline-none">\n          </div>\n\n          <div>\n            <label class="text-xs font-medium text-text-muted mb-1 block">Notes (Optional)</label>\n            <input name="notes" placeholder="e.g. Chapters 1-5, bring calculator" \n              class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-secondary focus:ring-1 focus:ring-secondary outline-none">\n          </div>\n        </div>\n        <div class="p-4 flex justify-end gap-3 border-t border-glass-border bg-white/5">\n          <button type="button" class="cancel-btn font-bold py-2 px-4 text-text-muted hover:text-text-default transition-colors">Cancel</button>\n          <button type="submit" class="text-white font-bold py-2 px-6 rounded-xl bg-secondary shadow-neon-secondary hover:bg-secondary/90 transition-all">Add Exam</button>\n        </div>\n      </form>\n    </div>',modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal);const e=modalContainer.querySelector('input[name="date"]');e&&(e.min=getTodayString()),setTimeout(()=>modalContainer.querySelector('input[name="subject"]').focus(),100),modalContainer.querySelector("#exam-form").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),a=t.get("subject"),o=t.get("date"),n=t.get("notes");a&&o&&(await addExam(a,o,n),closeModal())})},showAddExpenseModal=(e="")=>{const t=`\n    <div class="modal-content w-full max-w-sm mx-auto p-6 animate-fade-in-up">\n      <h3 class="text-lg font-bold mb-4">Add Expense</h3>\n      <form id="expense-form" class="space-y-3">\n        <div>\n            <label class="text-xs font-medium text-gray-500">Amount (‚Çπ)</label>\n            <input name="amount" type="number" min="1" required class="w-full p-2 rounded-md border bg-gray-50 dark:bg-slate-800 border-gray-200 dark:border-slate-600 focus:ring-2 focus:ring-primary">\n        </div>\n        <div>\n            <label class="text-xs font-medium text-gray-500">Category</label>\n            <select name="category" class="w-full p-2 rounded-md border bg-gray-50 dark:bg-slate-800 border-gray-200 dark:border-slate-600">\n                <option value="Food" ${"Food"===e?"selected":""}>üçî Food</option>\n                <option value="Travel" ${"Travel"===e?"selected":""}>üöå Travel</option>\n                <option value="Stationery" ${"Stationery"===e?"selected":""}>‚úèÔ∏è Stationery</option>\n                <option value="Entertainment" ${"Entertainment"===e?"selected":""}>üé¨ Entertainment</option>\n                <option value="Other" ${"Other"===e?"selected":""}>üìù Other</option>\n            </select>\n        </div>\n        <div>\n            <label class="text-xs font-medium text-gray-500">Note (Optional)</label>\n            <input name="description" type="text" placeholder="e.g., Burger King" class="w-full p-2 rounded-md border bg-gray-50 dark:bg-slate-800 border-gray-200 dark:border-slate-600">\n        </div>\n        <div class="flex justify-end gap-2 mt-4">\n            <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">Cancel</button>\n            <button type="submit" class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-bold hover:opacity-90">Add Expense</button>\n        </div>\n      </form>\n    </div>`;modalContainer.innerHTML=t,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal),modalContainer.querySelector("#expense-form").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),a=t.get("amount"),o=t.get("category"),n=t.get("description");a&&!isNaN(a)&&(await addExpense(a,o,n),closeModal())}),setTimeout(()=>modalContainer.querySelector('input[name="amount"]').focus(),100)},showReviewModal=async()=>{if(!userId)return void showToast("Please sign in to write a review.");let e=null;try{const t=doc(db,`reviews/${userId}`),a=await getDoc(t);a.exists()&&(e=a.data())}catch(e){console.error("Error fetching review:",e)}const t=e?.rating||5,a=e?.comment||"",o=`\n    <div class="modal-content w-full max-w-sm mx-auto p-6 animate-fade-in-up">\n      <h3 class="text-lg font-bold mb-4 text-center">Rate Your Experience</h3>\n      <form id="review-form" class="space-y-4">\n        <div class="flex justify-center gap-2 mb-2" id="star-rating">\n          ${[1,2,3,4,5].map(e=>`\n            <button type="button" data-value="${e}" class="star-btn text-3xl transition-transform hover:scale-110 ${e<=t?"text-yellow-400":"text-gray-300"}">‚òÖ</button>\n          `).join("")}\n        </div>\n        <input type="hidden" name="rating" id="rating-input" value="${t}">\n        \n        <div>\n            <label class="text-xs font-medium text-gray-500">Your Feedback</label>\n            <textarea name="comment" rows="4" class="w-full p-3 rounded-xl border border-glass-border bg-white/5 text-text-default focus:border-primary focus:ring-1 focus:ring-primary outline-none resize-none" placeholder="What do you love? What can we improve?">${a}</textarea>\n        </div>\n        \n        <div class="flex justify-end gap-2 mt-4">\n            <button type="button" class="cancel-btn px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">Cancel</button>\n            <button type="submit" class="px-6 py-2 rounded-lg bg-primary text-white text-sm font-bold hover:opacity-90 shadow-neon">Submit Review</button>\n        </div>\n      </form>\n    </div>`;modalContainer.innerHTML=o,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex");const n=modalContainer.querySelectorAll(".star-btn"),s=modalContainer.querySelector("#rating-input");n.forEach(e=>{e.addEventListener("click",()=>{const t=parseInt(e.dataset.value);s.value=t,n.forEach(e=>{parseInt(e.dataset.value)<=t?(e.classList.remove("text-gray-300"),e.classList.add("text-yellow-400")):(e.classList.remove("text-yellow-400"),e.classList.add("text-gray-300"))})})}),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal),modalContainer.querySelector("#review-form").addEventListener("submit",async e=>{e.preventDefault();const t=new FormData(e.target),a=parseInt(t.get("rating")),o=t.get("comment");try{await setDoc(doc(db,`reviews/${userId}`),{userId:userId,displayName:userProfile.displayName||"Anonymous",photoURL:userProfile.photoURL||null,rating:a,comment:o,updatedAt:(new Date).toISOString()}),showToast("Thank you for your review! üåü"),closeModal()}catch(e){console.error("Error submitting review:",e),showToast("Failed to submit review.")}})},showFinanceHistoryModal=()=>{const e=new Date,t=e.toISOString().slice(0,7),a=new Date(e.getFullYear(),e.getMonth()-1,1),o=a.toISOString().slice(0,7),n=a.toLocaleString("default",{month:"short"}),s=expenses.filter(e=>e.date.startsWith(t)).sort((e,t)=>new Date(t.date)-new Date(e.date)),r=expenses.filter(e=>e.date.startsWith(o)).reduce((e,t)=>e+(parseFloat(t.amount)||0),0),d=`\n    <div class="modal-content w-full max-w-md mx-auto p-0 overflow-hidden h-[80vh] flex flex-col">\n      <div class="p-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800">\n        <h3 class="text-lg font-bold">Monthly Statement üìú</h3>\n        <button class="cancel-btn text-gray-400 hover:text-gray-600 text-2xl">&times;</button>\n      </div>\n      \n      <div class="p-4 bg-blue-50 dark:bg-slate-900 grid grid-cols-2 gap-4">\n        <div>\n            <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-1">This Month</div>\n            <div class="text-3xl font-bold text-gray-800 dark:text-white">‚Çπ${s.reduce((e,t)=>e+(parseFloat(t.amount)||0),0)}</div>\n        </div>\n        <div class="border-l border-gray-200 dark:border-slate-700 pl-4">\n            <div class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-1">Last Month (${n})</div>\n            <div class="text-2xl font-bold text-gray-600 dark:text-gray-300">‚Çπ${r}</div>\n        </div>\n      </div>\n\n      <div class="finance-history-list flex-1 overflow-y-auto p-4 custom-scrollbar">\n        ${s.length>0?s.map(e=>{const t=new Date(e.date).toLocaleDateString(void 0,{day:"numeric",month:"short"});new Date(e.date).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"});return`\n        <div class="expense-row flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 rounded-lg mb-2" data-id="${e.id}">\n                <div class="flex items-center gap-3">\n                    <div class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 flex items-center justify-center text-lg shadow-sm">\n                        ${"Food"===e.category?"üçî":"Travel"===e.category?"üöå":"Stationery"===e.category?"‚úèÔ∏è":"Entertainment"===e.category?"üé¨":"üìù"}\n                    </div>\n                    <div>\n                        <div class="font-medium text-sm">${e.category}</div>\n                        <div class="text-xs text-gray-500">${e.description||"No note"} ‚Ä¢ ${t}</div>\n                    </div>\n                </div>\n          <div class="flex items-center gap-3">\n            <div class="font-bold text-red-500">-‚Çπ${e.amount}</div>\n            <button class="delete-expense text-xs text-red-500 hover:text-red-700 font-semibold" data-id="${e.id}" type="button">Delete</button>\n          </div>\n            </div>\n        `}).join(""):'<div class="text-center text-gray-500 py-8">No expenses this month yet!</div>'}\n      </div>\n    </div>`;modalContainer.innerHTML=d,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal);const i=modalContainer.querySelector(".finance-history-list");i?.addEventListener("click",async e=>{const t=e.target;if(t.classList.contains("delete-expense")){const e=t.dataset.id;await deleteExpense(e),t.closest(".expense-row")?.remove(),renderFinance()}})},showAvatarPickerModal=()=>{let e="",t=userProfile.photoURL||"";for(let a=1;a<=40;a++){const o=String(a).padStart(2,"0"),n=`avatars/${`Girl=On, Avatar=${o}.png`}`,s=t===n;e+=`\n            <div class="avatar-option cursor-pointer p-2 rounded-lg transition-colors flex justify-center items-center ${s?"bg-primary/10 ring-2 ring-primary":"hover:bg-gray-100 dark:hover:bg-slate-700"}" data-src="${n}">\n                <img src="${n}" alt="Avatar ${o}" class="w-16 h-16 rounded-full object-cover border-2 ${s?"border-primary":"border-transparent"} transition-all">\n            </div>\n        `}const a=`\n    <div class="modal-content w-full max-w-2xl mx-auto p-6 animate-fade-in-up h-[80vh] flex flex-col">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-bold">Edit Profile</h3>\n        <button class="cancel-btn text-gray-500 hover:text-gray-700">\n            <span class="material-symbols-outlined">close</span>\n        </button>\n      </div>\n\n      <div class="mb-4">\n        <label class="text-xs font-semibold text-gray-500 mb-1 block">Display Name</label>\n        <input type="text" id="new-display-name" value="${userProfile.displayName||""}" placeholder="Enter your name" class="w-full p-2 rounded-md border bg-gray-50 dark:bg-slate-800 border-gray-200 dark:border-slate-600 focus:ring-2 focus:ring-primary outline-none">\n      </div>\n      \n      <div class="text-xs font-semibold text-gray-500 mb-2">Choose an Avatar</div>\n      <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-4 overflow-y-auto p-2 custom-scrollbar flex-grow">\n        ${e}\n      </div>\n      \n      <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">\n        <button class="cancel-btn px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-sm font-medium">Cancel</button>\n        <button id="save-profile-btn" class="px-6 py-2 bg-primary text-white rounded-lg font-bold text-sm hover:opacity-90 transition-opacity shadow-lg shadow-primary/30">Save Changes</button>\n      </div>\n    </div>`;modalContainer.innerHTML=a,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelectorAll(".cancel-btn").forEach(e=>e.addEventListener("click",closeModal)),modalContainer.querySelectorAll(".avatar-option").forEach(e=>{e.addEventListener("click",()=>{modalContainer.querySelectorAll(".avatar-option").forEach(e=>{e.classList.remove("bg-primary/10","ring-2","ring-primary"),e.querySelector("img").classList.remove("border-primary"),e.querySelector("img").classList.add("border-transparent")}),e.classList.add("bg-primary/10","ring-2","ring-primary"),e.querySelector("img").classList.remove("border-transparent"),e.querySelector("img").classList.add("border-primary"),t=e.dataset.src})}),modalContainer.querySelector("#save-profile-btn").addEventListener("click",async()=>{const e=modalContainer.querySelector("#new-display-name").value.trim(),a={};let o=!1;if(e&&e!==userProfile.displayName){userProfile.displayName=e,a.displayName=e,o=!0;const t=document.getElementById("user-name");t&&(t.innerText=e);const n=document.getElementById("greeting-user");n&&(n.innerText=e.split(" ")[0])}if(t&&t!==userProfile.photoURL){userProfile.photoURL=t,a.photoURL=t,o=!0;const e=document.getElementById("user-avatar");e&&(e.src=t)}if(o){if(isLocalMode)localStore.set("profile",userProfile),showToast("Profile updated locally! ‚ú®");else if(userId){const e=doc(db,`users/${userId}`);await setDoc(e,a,{merge:!0}),showToast("Profile updated successfully! ‚ú®")}}else showToast("No changes to save.");closeModal()})},showQRCodeModal=()=>{modalContainer.innerHTML='\n    <div class="modal-content p-6 animate-fade-in-up flex flex-col items-center max-w-md w-full mx-4 relative overflow-hidden border border-glass-border shadow-neon">\n      \x3c!-- Decorative Background Blur --\x3e\n      <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-primary/10 to-transparent pointer-events-none"></div>\n      \n      <div class="flex justify-between items-center w-full mb-6 z-10">\n        <h3 class="text-xl font-bold text-text-default flex items-center gap-2">\n            <span class="material-symbols-outlined text-primary">qr_code_scanner</span>\n            Scan to Donate\n        </h3>\n        <button class="cancel-btn p-2 rounded-full hover:bg-white/10 text-text-muted hover:text-danger transition-colors">\n            <span class="material-symbols-outlined">close</span>\n        </button>\n      </div>\n      \n      <div class="bg-white p-4 rounded-2xl shadow-inner border-4 border-white/20 relative z-10">\n        <img src="qrcode.png" alt="Donation QR Code" class="w-64 h-64 object-contain rounded-lg">\n      </div>\n      \n      <div class="mt-6 text-center z-10">\n        <p class="text-sm font-medium text-text-default">Thank you for your support! üíñ</p>\n        <p class="text-xs text-text-muted mt-1">Every contribution helps improve Daily Dost.</p>\n      </div>\n    </div>',modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelector(".cancel-btn").addEventListener("click",closeModal)},showEditLimitModal=()=>{const e=`\n    <div class="modal-content w-full max-w-sm mx-auto p-6 space-y-4">\n      <div class="flex items-center justify-between">\n        <h3 class="text-lg font-bold">Set Monthly Limit</h3>\n        <button class="cancel-btn text-gray-400 hover:text-gray-600 text-2xl" type="button">&times;</button>\n      </div>\n      <label class="text-xs font-semibold text-gray-500">Monthly Limit (‚Çπ)</label>\n      <input id="limit-input" type="number" min="0" class="w-full p-3 rounded-lg border border-glass-border bg-white/70 dark:bg-slate-800" value="${userProfile.dailyLimit||2e3}">\n      <div class="flex justify-end gap-2">\n        <button class="cancel-btn px-4 py-2 rounded-lg border border-glass-border text-sm" type="button">Cancel</button>\n        <button id="save-limit" class="px-4 py-2 rounded-lg bg-primary text-white text-sm font-semibold" type="button">Save</button>\n      </div>\n    </div>`;modalContainer.innerHTML=e,modalContainer.classList.remove("hidden"),modalContainer.classList.add("flex"),modalContainer.querySelectorAll(".cancel-btn").forEach(e=>e.addEventListener("click",closeModal)),modalContainer.querySelector("#save-limit").addEventListener("click",async()=>{const e=parseFloat(modalContainer.querySelector("#limit-input").value);if(!(isNaN(e)||e<0)){if(userProfile.dailyLimit=e,renderFinance(),isLocalMode)localStore.set("profile",userProfile),showToast(`Monthly limit updated to ‚Çπ${e}`);else if(userId){const t=doc(db,`users/${userId}`);await setDoc(t,{dailyLimit:e},{merge:!0}),showToast(`Monthly limit updated to ‚Çπ${e}`)}closeModal()}})},calculateSleepCycles=()=>{const e=new Date;e.setMinutes(e.getMinutes()+15);let t='<div class="grid grid-cols-2 gap-2 mt-4">';for(let a=4;a<=6;a++){t+=`\n      <div class="p-2 rounded bg-blue-50 dark:bg-slate-800 text-center">\n        <div class="font-bold text-lg">${new Date(e.getTime()+90*a*6e4).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</div>\n        <div class="text-xs text-gray-500">${a} Cycles (${1.5*a}h)</div>\n      </div>\n    `}t+="</div>";const a=`\n    <div class="modal-content w-full max-w-sm mx-auto p-6">\n      <h3 class="text-lg font-bold mb-2">üí§ Best Wake-up Times</h3>\n      <p class="text-sm text-gray-500">If you go to bed right now (allowing 15m to fall asleep), you should wake up at:</p>\n      ${t}\n      <button id="close-sleep-modal" class="mt-4 w-full py-2 rounded-lg font-bold text-white" style="background-color: var(--primary);">Got it</button>\n    </div>`,o=document.createElement("div");o.className="modal-overlay",o.innerHTML=a,document.body.appendChild(o),o.querySelector("#close-sleep-modal").addEventListener("click",()=>o.remove())},drawPlant=e=>{const t=document.getElementById("plant-canvas");if(!t)return;const a=t.getContext("2d"),o=t.width,n=t.height;if(a.clearRect(0,0,o,n),a.fillStyle="#8B4513",a.beginPath(),a.ellipse(o/2,n-20,o/3,20,0,0,2*Math.PI),a.fill(),e<=0)return;const s=(n-60)*e;if(a.strokeStyle="#228B22",a.lineWidth=8,a.lineCap="round",a.beginPath(),a.moveTo(o/2,n-40),a.quadraticCurveTo(o/2+20*Math.sin(10*e),n-40-s/2,o/2,n-40-s),a.stroke(),e>.3&&(a.fillStyle="#32CD32",a.beginPath(),a.ellipse(o/2-10,n-40-.4*s,20,10,-.5,0,2*Math.PI),a.fill()),e>.6&&(a.beginPath(),a.ellipse(o/2+10,n-40-.7*s,15,8,.5,0,2*Math.PI),a.fill()),e>=.95){const e=o/2,t=n-40-s;a.fillStyle="#FF69B4";for(let o=0;o<5;o++)a.beginPath(),a.ellipse(e,t,15,30,o*Math.PI*2/5,0,2*Math.PI),a.fill();a.fillStyle="#FFD700",a.beginPath(),a.arc(e,t,10,0,2*Math.PI),a.fill()}};window.onload=()=>{initializeFirebase();const e=document.getElementById("habits-list");e&&e.addEventListener("click",e=>{const t=e.target.closest(".action-btn");if(t){e.stopPropagation();const a=t.closest(".habit-item");if(!a)return;const o=a.dataset.id,n=t.dataset.action;"complete"===n||"skip"===n?updateHabitStatus(o,n):"edit"===n&&showAddHabitModal(habits.find(e=>e.id===o))}});const t=document.getElementById("settings-btn");t&&t.addEventListener("click",()=>{showAvatarPickerModal()}),document.addEventListener("click",e=>{e.target&&"donation-qr-code"===e.target.id&&showQRCodeModal()}),document.getElementById("dark-mode-toggle").addEventListener("click",()=>{const e="dark"===document.documentElement.getAttribute("data-theme"),t=e?"light":"dark";document.documentElement.setAttribute("data-theme",t);const a=document.getElementById("theme-icon-sun"),o=document.getElementById("theme-icon-moon"),n=document.getElementById("theme-text");if(a&&o&&(a.classList.toggle("hidden",!e),o.classList.toggle("hidden",e)),n&&(n.textContent="dark"===t?"NIGHT":"DAY"),userId&&db){const e=doc(db,`users/${userId}`);setDoc(e,{settings:{theme:t}},{merge:!0})}}),document.getElementById("tab-dashboard")?.addEventListener("click",()=>switchView("dashboard-view")),document.getElementById("tab-study")?.addEventListener("click",()=>switchView("study-view")),document.getElementById("tab-analytics")?.addEventListener("click",()=>switchView("analytics-view")),document.getElementById("tab-rewards")?.addEventListener("click",()=>switchView("rewards-view")),document.getElementById("add-habit-btn")?.addEventListener("click",()=>showAddHabitModal()),document.getElementById("add-assignment-btn")?.addEventListener("click",()=>showAssignmentModal()),document.getElementById("add-grade-btn")?.addEventListener("click",showGradeModal),document.getElementById("pomodoro-start-btn")?.addEventListener("click",startPausePomodoro),document.getElementById("pomodoro-reset-btn")?.addEventListener("click",resetPomodoro),document.getElementById("pomodoro-work-btn")?.addEventListener("click",()=>switchPomodoroMode("work")),document.getElementById("pomodoro-short-break-btn")?.addEventListener("click",()=>switchPomodoroMode("shortBreak")),document.getElementById("pomodoro-long-break-btn")?.addEventListener("click",()=>switchPomodoroMode("longBreak")),document.getElementById("mood-tracker")?.addEventListener("click",e=>{e.target.dataset.mood&&setMentalHealthValue("moods",e.target.dataset.mood)}),document.getElementById("stress-tracker")?.addEventListener("click",e=>{e.target.dataset.stress&&setMentalHealthValue("stress",e.target.dataset.stress)}),document.getElementById("save-sleep-btn")?.addEventListener("click",saveSleepHours),document.getElementById("habit-analytics-selector")?.addEventListener("change",e=>{const t=e.target.value,a=document.getElementById("deep-dive-content");t?(a.classList.remove("hidden"),renderTrendChart(t),renderHeatmap(t)):a.classList.add("hidden")}),document.getElementById("assignment-list")?.addEventListener("click",e=>{e.target.classList.contains("toggle-assignment-btn")&&updateDoc(doc(db,`users/${userId}/academics`,e.target.dataset.id),{completed:!0})});const a=document.getElementById("toggle-calc-mode-btn"),o=document.getElementById("cgpa-calc-content"),n=document.getElementById("percentage-calc-content");a&&o&&n&&a.addEventListener("click",()=>{n.classList.contains("hidden")?(o.classList.add("hidden"),n.classList.remove("hidden"),a.innerText="Switch to CGPA"):(o.classList.remove("hidden"),n.classList.add("hidden"),a.innerText="Switch to Percentage %")});const s=document.getElementById("calc-percentage-btn");s&&s.addEventListener("click",()=>{const e=parseFloat(document.getElementById("total-marks-obtained").value),t=parseFloat(document.getElementById("total-max-marks").value),a=document.getElementById("percentage-value"),o=document.getElementById("percentage-grade");if(isNaN(e)||isNaN(t)||0===t)return void showToast("Please enter valid marks","error");const n=e/t*100;a.innerText=`${n.toFixed(2)}%`;let s="";s=n>=90?"Outstanding (A+)":n>=80?"Excellent (A)":n>=70?"Good (B)":n>=60?"Average (C)":n>=50?"Pass (D)":"Needs Improvement (F)",o.innerText=s,"undefined"!=typeof anime&&anime({targets:a,scale:[1,1.2,1],duration:500,easing:"easeOutElastic(1, .8)"})}),document.getElementById("user-avatar").addEventListener("click",async()=>{if(auth.currentUser){await showConfirmModal(`Signed in as ${auth.currentUser.displayName||auth.currentUser.email}. Do you want to sign out?`)&&(await auth.signOut(),showToast("Signed out successfully"),document.getElementById("user-avatar").src="https://placehold.co/40x40/cbd5e1/7c3aed?text=?",document.getElementById("user-level").innerText="Level 1")}else try{await signInWithGoogle()}catch(e){console.error("Sign in failed:",e)}}),document.getElementById("user-avatar").style.cursor="pointer",document.querySelectorAll(".expense-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.cat;showAddExpenseModal(t)})});const r=document.getElementById("finance-history-btn");r&&r.addEventListener("click",showFinanceHistoryModal);const d=document.getElementById("edit-limit-btn");d&&d.addEventListener("click",showEditLimitModal);const i=document.getElementById("write-review-btn");i&&i.addEventListener("click",showReviewModal);const l=document.getElementById("copy-upi-btn");l&&l.addEventListener("click",()=>{const e=document.getElementById("upi-id").innerText;navigator.clipboard.writeText(e).then(()=>{showToast("UPI ID copied to clipboard! üìã");const e=l.querySelector(".material-symbols-outlined");if(e){const t=e.innerText;e.innerText="check",l.classList.add("text-green-500"),l.classList.remove("text-text-muted"),setTimeout(()=>{e.innerText=t,l.classList.remove("text-green-500"),l.classList.add("text-text-muted")},2e3)}}).catch(e=>{console.error("Failed to copy: ",e),showToast("Failed to copy UPI ID")})}),document.getElementById("calc-sleep-cycle-btn")?.addEventListener("click",calculateSleepCycles),document.getElementById("insomnia-toggle")?.addEventListener("click",toggleWakeLock),document.addEventListener("visibilitychange",async()=>{null!==wakeLock&&"visible"===document.visibilityState&&await requestWakeLock()})};const stickyNotesList=document.getElementById("sticky-notes-list"),stickyNoteInput=document.getElementById("sticky-note-input"),addStickyNoteBtn=document.getElementById("add-sticky-note-btn");function renderStickyNotes(){stickyNotesList&&(stickyNotesList.innerHTML="",0!==stickyNotes.length?stickyNotes.forEach(e=>{const t=document.createElement("div");t.className="flex items-center gap-2 p-3 bg-accent/10 border border-accent/30 rounded-xl backdrop-blur-sm",t.innerHTML=`\n      <span class="flex-1 text-sm text-text-default">${e.text}</span>\n      <button class="text-xs px-3 py-1 rounded-lg hover:bg-danger/20 text-danger border border-danger/30 transition-all" data-id="${e.id}" type="button">Delete</button>\n    `,t.querySelector("button").onclick=function(){deleteStickyNote(this.getAttribute("data-id"))},stickyNotesList.appendChild(t)}):stickyNotesList.innerHTML='<p class="text-xs text-center text-text-muted">No notes yet. Add one!</p>')}async function addStickyNote(){const e=stickyNoteInput.value.trim();if(e&&userId)try{if(isLocalMode){const t={id:"local_"+Date.now(),text:e,createdAt:(new Date).toISOString()};stickyNotes.push(t),localStore.setArray("stickyNotes",stickyNotes),renderStickyNotes()}else await addDoc(collection(db,`users/${userId}/stickyNotes`),{text:e,createdAt:(new Date).toISOString()});stickyNoteInput.value=""}catch(e){console.error("Error adding note:",e),showToast("Failed to add note")}}async function deleteStickyNote(e){if(userId)try{isLocalMode?(stickyNotes=stickyNotes.filter(t=>t.id!==e),localStore.setArray("stickyNotes",stickyNotes),renderStickyNotes()):await deleteDoc(doc(db,`users/${userId}/stickyNotes`,e))}catch(e){console.error("Error deleting note:",e),showToast("Failed to delete note")}}addStickyNoteBtn&&stickyNoteInput&&stickyNotesList&&(addStickyNoteBtn.addEventListener("click",addStickyNote),stickyNoteInput.addEventListener("keypress",function(e){"Enter"===e.key&&addStickyNote()}));const calcDisplay=document.getElementById("calc-display"),calcBtns=document.querySelectorAll(".calc-btn");let calcInput="";function updateCalcDisplay(){calcDisplay&&(calcDisplay.value=calcInput||"0")}function handleCalcBtn(e){const t=e.target.getAttribute("data-val");null!==t&&(calcInput+=t,updateCalcDisplay())}function clearCalc(){calcInput="",updateCalcDisplay()}function evalCalc(){try{const expression=calcInput&&""!==calcInput.trim()?calcInput:"0",result=eval(expression.replace(/√∑/g,"/").replace(/√ó/g,"*")),safeResult=null==result||Number.isNaN(result)?0:result;calcInput=String(safeResult),updateCalcDisplay(),grantAchievement("math_whiz")}catch{calcInput="",calcDisplay&&(calcDisplay.value="Error")}}calcBtns.length>0&&calcBtns.forEach(e=>{"calc-clear"===e.id?e.onclick=clearCalc:"calc-del"===e.id?e.onclick=()=>{calcInput=calcInput.slice(0,-1),updateCalcDisplay()}:"calc-equals"===e.id?e.onclick=evalCalc:e.onclick=handleCalcBtn});const totalClassesInput=document.getElementById("total-classes"),attendedClassesInput=document.getElementById("attended-classes"),calcAttendanceBtn=document.getElementById("calc-attendance-btn"),attendanceResult=document.getElementById("attendance-result");if(calcAttendanceBtn){const e=localStorage.getItem("attendance_total"),t=localStorage.getItem("attendance_attended");e&&(totalClassesInput.value=e),t&&(attendedClassesInput.value=t),calcAttendanceBtn.addEventListener("click",()=>{const e=parseInt(totalClassesInput.value),t=parseInt(attendedClassesInput.value);if(isNaN(e)||isNaN(t)||e<=0)return attendanceResult.textContent="Please enter valid numbers.",attendanceResult.className="p-3 rounded-lg bg-red-100 text-red-800 text-sm font-medium text-center",void attendanceResult.classList.remove("hidden");if(t>e)return attendanceResult.textContent="Attended classes cannot be more than total classes.",attendanceResult.className="p-3 rounded-lg bg-red-100 text-red-800 text-sm font-medium text-center",void attendanceResult.classList.remove("hidden");localStorage.setItem("attendance_total",e),localStorage.setItem("attendance_attended",t);const a=t/e*100,o=75;let n=`Current Attendance: ${a.toFixed(1)}%<br>`,s="",r="";if(a>=o){const a=Math.floor((t-.75*e)/.75);a>0?(n+=`‚úÖ Safe Zone! You can bunk <strong>${a}</strong> more classes and stay above 75%.`,s="bg-green-100 dark:bg-green-900",r="text-green-800 dark:text-green-100"):(n+="‚ö†Ô∏è On the edge! Don't miss any classes right now.",s="bg-yellow-100 dark:bg-yellow-900",r="text-yellow-800 dark:text-yellow-100")}else{n+=`üö® Danger Zone! You must attend the next <strong>${Math.ceil((.75*e-t)/.25)}</strong> classes to reach 75%.`,s="bg-red-100 dark:bg-red-900",r="text-red-800 dark:text-red-100"}attendanceResult.innerHTML=n,attendanceResult.className=`p-3 rounded-lg ${s} ${r} text-sm font-medium text-center mt-3`,attendanceResult.classList.remove("hidden"),grantAchievement("bunk_master")})}const toggleWakeLock=async()=>{const e=document.getElementById("insomnia-toggle");if(wakeLock)await releaseWakeLock(),e.classList.remove("!text-accent","!border-accent","shadow-neon-accent"),e.classList.add("text-text-muted"),showToast("Insomnia Mode OFF");else{await requestWakeLock()&&(e.classList.add("!text-accent","!border-accent","shadow-neon-accent"),e.classList.remove("text-text-muted"),showToast("Insomnia Mode ON: Screen will stay awake üëÅÔ∏è"))}},requestWakeLock=async()=>{try{return"wakeLock"in navigator?(wakeLock=await navigator.wakeLock.request("screen"),wakeLock.addEventListener("release",()=>{console.log("Wake Lock released");const e=document.getElementById("insomnia-toggle");e&&(e.classList.remove("!text-accent","!border-accent","shadow-neon-accent"),e.classList.add("text-text-muted")),wakeLock=null}),!0):(showToast("Wake Lock not supported on this browser."),!1)}catch(e){return console.error(`${e.name}, ${e.message}`),!1}},releaseWakeLock=async()=>{null!==wakeLock&&(await wakeLock.release(),wakeLock=null)},AMBIANCE_SOUNDS={rain:"./sound/rain.mp3",ocean:"./sound/ocean_waves.mp3",forest:"./sound/forest_ambience.mp3",fire:"./sound/fire.mp3",water:"./sound/river.mp3",brown:"./sound/brown_noise.mp3"};let activeSources={},masterVolume=.5;const toggleAmbiance=e=>{if(activeSources[e]){const t=activeSources[e];t.pause(),t.currentTime=0,delete activeSources[e];const a=document.querySelector(`.ambiance-btn[data-sound="${e}"]`);a&&(a.classList.remove("bg-primary","text-white","border-primary"),a.classList.add("hover:bg-primary/20","hover:border-primary","hover:text-primary"),a.classList.add("text-text-muted"))}else{const t=AMBIANCE_SOUNDS[e];if(!t)return void console.warn(`No sound file mapped for type: ${e}`);const a=new Audio(t);a.loop=!0,a.volume=masterVolume,a.play().then(()=>{activeSources[e]=a;const t=document.querySelector(`.ambiance-btn[data-sound="${e}"]`);t&&(t.classList.add("bg-primary","text-white","border-primary"),t.classList.remove("text-text-muted","hover:bg-primary/20","hover:border-primary","hover:text-primary"))}).catch(t=>{console.error(`Failed to play ${e} ambiance:`,t),showToast(`Failed to play ${e} sound. Try again.`,"error")})}},setAmbianceVolume=e=>{masterVolume=e/100,Object.values(activeSources).forEach(e=>{e.volume=masterVolume})},signInWithGoogle=async()=>{const e=new GoogleAuthProvider;e.setCustomParameters({prompt:"select_account"});try{const t=(await signInWithPopup(auth,e)).user;return showToast(`Welcome, ${t.displayName}!`),updateUserProfile(t),t}catch(e){throw console.error("Google Sign-In Error:",e),showToast("Failed to sign in with Google"),e}},updateUserProfile=async e=>{try{if(!auth.currentUser||!userId)return!1;const t=doc(db,`users/${userId}`),a=await getDoc(t),o=a.exists()?a.data():{},n=o.displayName||e.displayName||e.email?.split("@")[0]||"User",s=o.photoURL||e.photoURL||`https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=667eea&color=fff&size=128`;await updateProfile(auth.currentUser,{displayName:n,photoURL:s}),await setDoc(t,{displayName:n,photoURL:s,email:e.email,lastSignIn:(new Date).toISOString()},{merge:!0});const r=document.getElementById("user-avatar"),d=document.getElementById("user-name");return r&&(r.src=s),d&&(d.innerText=n),console.log("Profile updated successfully"),{success:!0,isNew:!a.exists()}}catch(e){return console.error("Profile update error:",e),{success:!1,isNew:!1}}},initAnimeAnimations=()=>{anime({targets:".card",opacity:[0,1],translateY:[40,0],delay:anime.stagger(100),duration:800,easing:"easeOutCubic"}),anime({targets:".habit-item",opacity:[0,1],translateX:[-30,0],delay:anime.stagger(80),duration:600,easing:"easeOutExpo"}),anime({targets:".progress-item",opacity:[0,1],translateY:[30,0],delay:anime.stagger(100,{start:200}),duration:700,easing:"easeOutCubic"})},initGSAPAnimations=()=>{gsap.registerPlugin(ScrollTrigger);const e=document.getElementById("xp-bar");e&&gsap.from(e,{width:0,duration:1.5,ease:"power2.out",delay:.5}),document.querySelectorAll(".btn-animate").forEach(e=>{e.addEventListener("mouseenter",t=>{gsap.to(e,{scale:1.05,duration:.3,ease:"power2.out"})}),e.addEventListener("mouseleave",t=>{gsap.to(e,{scale:1,duration:.3,ease:"power2.out"})})})};setTimeout(()=>{loadingOverlay.classList.contains("hidden")||(loadingOverlay.classList.add("hidden"),showToast("Taking longer than expected. You can still use the app."))},8e3),document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{initAnimeAnimations(),initGSAPAnimations()},100)});const animateDashboardItems=()=>{setTimeout(()=>{anime({targets:".habit-item",opacity:[0,1],translateX:[-20,0],delay:anime.stagger(60),duration:500,easing:"easeOutExpo"})},50)},animateHabitCompletion=e=>{anime({targets:e,scale:[1,1.1,1],duration:600,easing:"easeInOutQuad",complete:()=>{gsap.to(e,{x:window.innerWidth,opacity:0,duration:.5,ease:"power2.in"})}})},analyticsView=document.getElementById("analytics-view");let deferredPrompt;analyticsView&&analyticsView.querySelectorAll(".card").forEach(e=>{e.classList.remove("card-hover")}),console.log("üé® Animation enhancements loaded!");const installBtn=document.getElementById("install-app-btn"),installGuideModal=document.getElementById("install-guide-modal"),closeInstallGuide=document.getElementById("close-install-guide"),guideInstallBtn=document.getElementById("guide-install-btn"),installActionContainer=document.getElementById("install-action-container"),isStandalone=window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone;installBtn&&!isStandalone&&(installBtn.classList.remove("hidden"),installBtn.addEventListener("click",()=>{installGuideModal&&installGuideModal.classList.remove("hidden")})),guideInstallBtn&&guideInstallBtn.addEventListener("click",async()=>{if(deferredPrompt){deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;console.log(`User response to the install prompt: ${e}`),deferredPrompt=null,installActionContainer&&installActionContainer.classList.add("hidden"),installGuideModal&&installGuideModal.classList.add("hidden")}}),closeInstallGuide&&installGuideModal&&(closeInstallGuide.addEventListener("click",()=>{installGuideModal.classList.add("hidden")}),installGuideModal.addEventListener("click",e=>{e.target===installGuideModal&&installGuideModal.classList.add("hidden")})),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,console.log("beforeinstallprompt fired"),installActionContainer&&installActionContainer.classList.remove("hidden")}),window.addEventListener("appinstalled",()=>{installBtn&&installBtn.classList.add("hidden"),installGuideModal&&installGuideModal.classList.add("hidden"),deferredPrompt=null,console.log("PWA was installed"),showToast("StudiOS installed successfully!","success")}),window.showGradeModal=showGradeModal,window.showGradeHistoryModal=showGradeHistoryModal,window.toggleAmbiance=toggleAmbiance,window.setAmbianceVolume=setAmbianceVolume;const setupEventListeners=()=>{console.log("Setting up event listeners...");const e=localStorage.getItem("studios_exams");if(e)try{exams=JSON.parse(e)}catch(e){console.warn("Failed to parse stored exams:",e),exams=[]}renderExams();const t=document.getElementById("add-grade-radar-btn");t&&t.addEventListener("click",showGradeModal);const a=document.getElementById("grade-history-btn");a&&a.addEventListener("click",showGradeHistoryModal);const o=document.querySelectorAll(".ambiance-btn");console.log(`Found ${o.length} ambiance buttons`),o.forEach(e=>{e.onclick=()=>toggleAmbiance(e.dataset.sound)});const n=document.getElementById("ambiance-volume");n&&n.addEventListener("input",e=>{setAmbianceVolume(e.target.value)});const s=document.getElementById("add-exam-btn");s&&s.addEventListener("click",showAddExamModal);const r=document.getElementById("close-login-modal-btn"),d=document.getElementById("login-modal");r&&d&&r.addEventListener("click",()=>{d.classList.add("hidden")})},initApp=()=>{setupEventListeners(),initAnimeAnimations(),initGSAPAnimations()};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initApp):initApp();